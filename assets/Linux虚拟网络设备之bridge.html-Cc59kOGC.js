import{ah as i,ai as a,ar as n,am as l}from"./app-dFTP4NUG.js";const h={};function e(k,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h1 id="linux虚拟网络设备之bridge" tabindex="-1"><a class="header-anchor" href="#linux虚拟网络设备之bridge"><span>Linux虚拟网络设备之bridge</span></a></h1><p>转自：<a href="https://segmentfault.com/a/1190000009491002" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000009491002</a></p><p>继前两篇介绍了<a href="https://segmentfault.com/a/1190000009249039" target="_blank" rel="noopener noreferrer">tun/tap</a>和<a href="https://segmentfault.com/a/1190000009251098" target="_blank" rel="noopener noreferrer">veth</a>之后，本篇将介绍Linux下常用的一种虚拟网络设备，那就是bridge(桥)。</p><p>本篇将通过实际的例子来一步一步解释bridge是如何工作的。</p><h2 id="什么是bridge" tabindex="-1"><a class="header-anchor" href="#什么是bridge"><span>什么是bridge？</span></a></h2><p>首先，bridge是一个虚拟网络设备，所以具有网络设备的特征，可以配置IP、MAC地址等；其次，bridge是一个虚拟交换机，和物理交换机有类似的功能。</p><p>对于普通的网络设备来说，只有两端，从一端进来的数据会从另一端出去，如物理网卡从外面网络中收到的数据会转发给内核协议栈，而从协议栈过来的数据会转发到外面的物理网络中。</p><p>而bridge不同，bridge有多个端口，数据可以从任何端口进来，进来之后从哪个口出去和物理交换机的原理差不多，要看mac地址。</p><h2 id="创建bridge" tabindex="-1"><a class="header-anchor" href="#创建bridge"><span>创建bridge</span></a></h2><p>我们先用iproute2创建一个bridge：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bridge</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>当刚创建一个bridge时，它是一个独立的网络设备，只有一个端口连着协议栈，其它的端口啥都没连，这样的bridge没有任何实际功能，如下图所示：</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|              ↑                                ↑                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|..............|................................|................|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|              ↓                                ↓                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +----------+                     +------------+         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        |   eth0   |                     |     br0    |         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +----------+                     +------------+         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">| 192.168.3.21 ↑                                                 |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|              |                                                 |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|              |                                                 |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+--------------|-------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">               ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">         Physical Network</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这里假设eth0是我们的物理网卡，IP地址是192.168.3.21，网关是192.168.3.1</p></blockquote><h2 id="将bridge和veth设备相连" tabindex="-1"><a class="header-anchor" href="#将bridge和veth设备相连"><span>将bridge和veth设备相连</span></a></h2><p>创建一对veth设备，并配置上IP</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.102/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将veth0连上br0</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#通过bridge link命令可以看到br0上连接了哪些设备</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bridge</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">6:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1500</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> forwarding</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> priority</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cost</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这时候，网络就变成了这个样子:</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑            ↑              |            ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|............|............|..............|............|..........|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↓            ↓              ↓            ↓          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | .3.21|     |        |     | .3.101|    | .3.102|      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |     |   br0  |&lt;---&gt;| veth0 |    | veth1 |      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑                           ↑            ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           |            |          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           +------------+          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这里为了画图方便，省略了IP地址前面的192.168，比如.3.21就表示192.168.3.21</p></blockquote><p>br0和veth0相连之后，发生了几个变化：</p><ul><li>br0和veth0之间连接起来了，并且是双向的通道</li><li>协议栈和veth0之间变成了单通道，协议栈能发数据给veth0，但veth0从外面收到的数据不会转发给协议栈</li><li>br0的mac地址变成了veth0的mac地址</li></ul><p>相当于bridge在veth0和协议栈之间插了一脚，在veth0上面做了点小动作，将veth0本来要转发给协议栈的数据给拦截了，全部转发给bridge了，同时bridge也可以向veth0发数据。</p><p>下面来检验一下是不是这样的：</p><p>通过veth0 ping veth1失败：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.2.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.2.1) from 192.168.2.11 veth0: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">From</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.2.11</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Host</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Unreachable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.2.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> errors,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 100%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么veth0加入了bridge之后，就ping不通veth2了呢？ 先抓包看看：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#由于veth0的arp缓存里面没有veth1的mac地址，所以ping之前先发arp请求</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#从veth1上抓包来看，veth1收到了arp请求，并且返回了应答</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcpdump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tcpdump:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> verbose</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> output</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> suppressed,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> use</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -vv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> full</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> decode</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listening</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link-type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EN10MB</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Ethernet), capture size 262144 bytes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">21:43:48.353509</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ARP,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Request</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> who-has</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tell</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> length</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">21:43:48.353518</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ARP,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Reply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is-at</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 26:58:a2:57:37:e9,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> length</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#从veth0上抓包来看，数据包也发出去了，并且也收到了返回</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcpdump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tcpdump:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> verbose</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> output</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> suppressed,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> use</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -vv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> full</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> decode</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listening</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link-type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EN10MB</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Ethernet), capture size 262144 bytes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">21:44:09.775392</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ARP,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Request</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> who-has</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tell</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> length</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">21:44:09.775400</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ARP,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Reply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is-at</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 26:58:a2:57:37:e9,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> length</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#再看br0上的数据包，发现只有应答</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcpdump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tcpdump:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> verbose</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> output</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> suppressed,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> use</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -vv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> full</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> decode</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listening</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link-type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> EN10MB</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Ethernet), capture size 262144 bytes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">21:45:48.225459</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ARP,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Reply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is-at</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 26:58:a2:57:37:e9,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> length</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的抓包可以看出，去和回来的流程都没有问题，问题就出在veth0收到应答包后没有给协议栈，而是给了br0，于是协议栈得不到veth1的mac地址，从而通信失败。</p><h2 id="给bridge配上ip" tabindex="-1"><a class="header-anchor" href="#给bridge配上ip"><span>给bridge配上IP</span></a></h2><p>通过上面的分析可以看出，给veth0配置IP没有意义，因为就算协议栈传数据包给veth0，应答包也回不来。这里我们就将veth0的IP让给bridge。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> del</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>于是网络变成了这样子：</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑            ↑                           ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|............|............|...........................|..........|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↓            ↓                           ↓          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | .3.21|     | .3.101 |     |       |    | .3.102|      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |     |   br0  |&lt;---&gt;| veth0 |    | veth1 |      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑                           ↑            ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           |            |          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           +------------+          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>其实veth0和协议栈之间还是有联系的，但由于veth0没有配置IP，所以协议栈在路由的时候不会将数据包发给veth0，就算强制要求数据包通过veth0发送出去，但由于veth0从另一端收到的数据包只会给br0，所以协议栈还是没法收到相应的arp应答包，导致通信失败。 这里为了表达更直观，将协议栈和veth0之间的联系去掉了，veth0相当于一根网线。</p></blockquote><p>再通过br0 ping一下veth1，结果成功</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.102) from 192.168.3.101 br0: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.102:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0.121</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.102</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0.121/0.121/0.121/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但ping网关还是失败，因为这个bridge上只有两个网络设备，分别是192.168.3.101和192.168.3.102，br0不知道192.168.3.1在哪。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) from 192.168.3.101 br0: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">From</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.101</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Host</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Unreachable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> errors,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 100%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="将物理网卡添加到bridge" tabindex="-1"><a class="header-anchor" href="#将物理网卡添加到bridge"><span>将物理网卡添加到bridge</span></a></h2><p>将eth0添加到br0上：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bridge</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1500</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> forwarding</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> priority</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cost</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">6:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1500</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> forwarding</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> priority</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cost</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>br0根本不区分接入进来的是物理设备还是虚拟设备，对它来说都一样的，都是网络设备，所以当eth0加入br0之后，落得和上面veth0一样的下场，从外面网络收到的数据包将无条件的转发给br0，自己变成了一根网线。</p><p>这时通过eth0来ping网关失败，但由于br0通过eth0这根网线连上了外面的物理交换机，所以连在br0上的设备都能ping通网关，这里连上的设备就是veth1和br0自己，veth1是通过veth0这根网线连上去的，而br0可以理解为自己有一块自带的网卡。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#通过eth0来ping网关失败</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) from 192.168.3.21 eth0: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">From</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Host</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Unreachable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> errors,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 100%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#通过br0来ping网关成功</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) from 192.168.3.101 br0: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">27.5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 27.518/27.518/27.518/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#通过veth1来ping网关成功</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) from 192.168.3.102 veth1: 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">68.8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 68.806/68.806/68.806/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于eth0已经变成了和网线差不多的功能，所以在eth0上配置IP已经没有什么意义了，并且还会影响协议栈的路由选择，比如如果上面ping的时候不指定网卡的话，协议栈有可能优先选择eth0，导致ping不通，所以这里需要将eth0上的IP去掉。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#在本人的测试机器上，由于eth0上有IP，</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#访问192.168.3.0/24网段时，会优先选择eth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> routing</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> table</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Gateway</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         Genmask</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         Flags</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Metric</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ref</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    Use</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Iface</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">default</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">         192.168.3.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0.0.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         UG</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">link-local</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     1000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">192.168.3.0</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.255.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">192.168.3.0</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.255.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">192.168.3.0</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.255.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#由于eth0已结接入了br0，所有它收到的数据包都会转发给br0，</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#于是协议栈收不到arp应答包，导致ping失败</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">From</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Host</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Unreachable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> errors,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 100%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#将eth0上的IP删除掉</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> del</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.21/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#再ping一次，成功</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3.91</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3.916/3.916/3.916/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#这是因为eth0没有IP之后，路由表里面就没有它了，于是数据包会从veth1出去</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> routing</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> table</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Gateway</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         Genmask</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         Flags</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Metric</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ref</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    Use</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Iface</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">192.168.3.0</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.255.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">192.168.3.0</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">               255.255.255.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   U</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">     0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#从这里也可以看出，由于原来的默认路由走的是eth0，所以当eth0的IP被删除之后，</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#默认路由不见了，想要连接192.168.3.0/24以外的网段的话，需要手动将默认网关加回来</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#添加默认网关，然后再ping外网成功</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> baidu.com</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> baidu.com</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (111.13.101.208) 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 111.13.101.208:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">51</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30.6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> baidu.com</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 30.690/30.690/30.690/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经过上面一系列的操作后，网络变成了这个样子：</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                         ↑                           ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|.........................|...........................|..........|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                         ↓                           ↓          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        |      |     | .3.101 |     |       |    | .3.102|      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |&lt;---&gt;|   br0  |&lt;---&gt;| veth0 |    | veth1 |      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑                           ↑            ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           |            |          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           +------------+          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的操作中有几点需要注意：</p><ul><li><p>如果是在虚拟机上做上述操作，记得打开网卡的混杂模式（不是在Linux里面，而是在虚拟机的配置上面，如VirtualBox上相应虚拟机的网卡配置项里面），不然veth1的网络会不通，因为eth0不在混杂模式的话，会丢掉目的mac地址是veth1的数据包</p></li><li><p>上面虽然通了，但由于Linux下arp的特性，当协议栈收到外面的arp请求时，不管是问101还是102，都会回复两个arp应答，分别包含br0和veth1的mac地址，也即Linux觉得外面发给101和102的数据包从br0和veth1进协议栈都一样，没有区别。由于回复了两个arp应答，而外面的设备只会用其中的一个，并且具体用哪个会随着时间发生变化，于是导致一个问题，就是外面回复给102的数据包可能从101的br0上进来，即通过102 ping外面时，可能在veth1抓不到回复包，而在br0上能抓到回复包。说明数据流在交换机那层没有完全的隔离开，br0和veth1会收到对方的IP应答包。为了解决上述问题，可以配置rp_filter, arp_filter, arp_ignore, arp_announce等参数，但不建议这么做，容易出错，调试比较麻烦。</p></li><li><p>在无线网络环境中，情况会变得比较复杂，因为无线网络需要登录，登陆后无线路由器只认一个mac地址，所有从这台机器出去的mac地址都必须是那一个，于是通过无线网卡上网的机器上的所有虚拟机想要上网的话，都必须依赖虚拟机管理软件（如VirtualBox）将每个虚拟机的网卡mac地址转成出口的mac地址（即无线网卡的mac地址），数据包回来的时候还要转回来，所以如果一个IP有两个ARP应答包的话，有可能导致mac地址的转换有问题，导致网络不通，或者有时通有时不通。解决办法就是将连接进br0的所有设备的mac地址都改成和eth0一样的mac地址，因为eth0的mac地址会被虚拟机正常的做转换。在上面的例子中，执行下面的命令即可：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> down</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#08:00:27:3b:0d:b9是eth0的mac地址</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> address</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 08:00:27:3b:0d:b9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="bridge必须要配置ip吗" tabindex="-1"><a class="header-anchor" href="#bridge必须要配置ip吗"><span>bridge必须要配置IP吗？</span></a></h2><p>在我们常见的物理交换机中，有可以配置IP和不能配置IP两种，不能配置IP的交换机一般通过com口连上去做配置（更简单的交换机连com口的没有，不支持任何配置），而能配置IP的交换机可以在配置好IP之后，通过该IP远程连接上去做配置，从而更方便。</p><p>bridge就属于后一种交换机，自带虚拟网卡，可以配置IP，该虚拟网卡一端连在bridge上，另一端跟协议栈相连。和物理交换机一样，bridge的工作不依赖于该虚拟网卡，但bridge工作不代表机器能连上网，要看组网方式。</p><p>删除br0上的IP:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> del</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.101/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> br0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>于是网络变成了这样子，相当于br0的一个端口通过eth0连着交换机，另一个端口通过veth0连着veth1：</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                     ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|.....................................................|..........|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                     ↓          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        |      |     |        |     |       |    | .3.102|      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |&lt;---&gt;|   br0  |&lt;---&gt;| veth0 |    | veth1 |      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+    +-------+      |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑                           ↑            ↑          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           |            |          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                           +------------+          |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ping网关成功，说明这种情况下br0不配置IP对通信没有影响，数据包还能从veth1出去：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev@debian:~$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (192.168.3.1) 56(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> icmp_seq=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1.24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.3.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistics</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packets</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> transmitted,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> received,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0%</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loss,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0ms</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> min/avg/max/mdev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1.242/1.242/1.242/0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>上面如果没有veth0和veth1的话，删除br0上的IP后，网络将会不通，因为没有设备和协议栈完全相连</p></blockquote><h3 id="bridge常用场景" tabindex="-1"><a class="header-anchor" href="#bridge常用场景"><span>bridge常用场景</span></a></h3><p>上面通过例子展示了bridge的功能，但例子中的那种部署方式没有什么实际用途，还不如在一个网卡上配置多个IP地址来的直接。这里来介绍两种常见的部署方式。</p><h4 id="虚拟机" tabindex="-1"><a class="header-anchor" href="#虚拟机"><span>虚拟机</span></a></h4><p>虚拟机通过tun/tap或者其它类似的虚拟网络设备，将虚拟机内的网卡同br0连接起来，这样就达到和真实交换机一样的效果，虚拟机发出去的数据包先到达br0，然后由br0交给eth0发送出去，数据包都不需要经过host机器的协议栈，效率高。</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+-----------------------------------------+-----------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                          Host                                  |              VirtualMachine1            |              VirtualMachine2            |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |       |  Newwork Protocol Stack |       |       |  Newwork Protocol Stack |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                          ↑                                     |                   ↑                     |                    ↑                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|..........................|.....................................|...................|.....................|....................|....................|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                          ↓                                     |                   ↓                     |                    ↓                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                     +--------+                                 |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                     | .3.101 |                                 |               | .3.102|                 |                | .3.103|                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |&lt;---&gt;|   br0  |&lt;---&gt;|tun/tap|                   |               | eth0  |                 |                | eth0  |                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑             ↑             ↑                       |                   ↑                     |                    ↑                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             |             +-------------------------------------------+                     |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             ↓                                     |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         +-------+                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         |tun/tap|                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         +-------+                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             ↑                                     |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             +-------------------------------------------------------------------------------|--------------------+                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+-----------------------------------------+-----------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network  (192.168.3.0/24)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="docker" tabindex="-1"><a class="header-anchor" href="#docker"><span>docker</span></a></h4><p>由于容器运行在自己单独的network namespace里面，所以都有自己单独的协议栈，情况和上面的虚拟机差不多，但它采用了另一种方式来和外界通信：</p><div class="language-gherkin line-numbers-mode" data-highlighter="shiki" data-ext="gherkin" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-gherkin"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+----------------------------------------------------------------+-----------------------------------------+-----------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                          Host                                  |              Container 1                |              Container 2                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|                                                                |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       |             Newwork Protocol Stack             |       |       |  Newwork Protocol Stack |       |       |  Newwork Protocol Stack |       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑             ↑                                     |                   ↑                     |                    ↑                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|............|.............|.....................................|...................|.....................|....................|....................|</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↓             ↓                                     |                   ↓                     |                    ↓                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+                                 |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        |.3.101|     |  .9.1  |                                 |               |  .9.2 |                 |                |  .9.3 |                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        | eth0 |     |   br0  |&lt;---&gt;|  veth |                   |               | eth0  |                 |                | eth0  |                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            ↑             ↑             ↑                       |                   ↑                     |                    ↑                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             |             +-------------------------------------------+                     |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             ↓                                     |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         +-------+                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         |  veth |                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |         +-------+                                 |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             ↑                                     |                                         |                    |                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |             +-------------------------------------------------------------------------------|--------------------+                    |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|            |                                                   |                                         |                                         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------|---------------------------------------------------+-----------------------------------------+-----------------------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             ↓</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     Physical Network  (192.168.3.0/24)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>容器中配置网关为.9.1，发出去的数据包先到达br0，然后交给host机器的协议栈，由于目的IP是外网IP，且host机器开启了IP forward功能，于是数据包会通过eth0发送出去，由于.9.1是内网IP，所以一般发出去之前会先做NAT转换（NAT转换和IP forward功能都需要自己配置）。由于要经过host机器的协议栈，并且还要做NAT转换，所以性能没有上面虚拟机那种方案好，优点是容器处于内网中，安全性相对要高点。（由于数据包统一由IP层从eth0转发出去，所以不存在mac地址的问题，在无线网络环境下也工作良好）</p><blockquote><p>上面两种部署方案中，同一网段的每个网卡都有自己单独的协议栈，所以不存在上面说的多个ARP的问题</p></blockquote><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h2><ul><li><a href="https://cloud.tencent.com/developer/article/1115583" target="_blank" rel="noopener noreferrer">Linux 上的基础网络设备详解</a></li><li><a href="https://lwn.net/Articles/45373/" target="_blank" rel="noopener noreferrer">Harping on ARP</a></li><li><a href="https://wiki.archlinuxcn.org/wiki/MAC_%E5%9C%B0%E5%9D%80%E6%AC%BA%E9%AA%97" target="_blank" rel="noopener noreferrer">MAC address spoofing</a></li><li><a href="https://wiki.linuxfoundation.org/networking/bridge#it-doesn-t-work-with-my-wireless-card" target="_blank" rel="noopener noreferrer">It doesn&#39;t work with my Wireless card!T</a></li></ul>`,75)]))}const p=i(h,[["render",e]]),d=JSON.parse('{"path":"/note-book/OperaSystems/Linux%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E4%B9%8Bbridge.html","title":"Linux虚拟网络设备之bridge","lang":"zh-CN","frontmatter":{"description":"Linux虚拟网络设备之bridge 转自：https://segmentfault.com/a/1190000009491002 继前两篇介绍了tun/tap和veth之后，本篇将介绍Linux下常用的一种虚拟网络设备，那就是bridge(桥)。 本篇将通过实际的例子来一步一步解释bridge是如何工作的。 什么是bridge？ 首先，bridge是...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Linux虚拟网络设备之bridge\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-04-19T06:16:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Paper-Dragon\\",\\"url\\":\\"https://github.com/Paper-Dragon\\",\\"email\\":\\"2678885646@qq.com\\"}]}"],["meta",{"property":"og:url","content":"https://www.geekery.cn/note-book/OperaSystems/Linux%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E4%B9%8Bbridge.html"}],["meta",{"property":"og:site_name","content":"运维开发绿皮书"}],["meta",{"property":"og:title","content":"Linux虚拟网络设备之bridge"}],["meta",{"property":"og:description","content":"Linux虚拟网络设备之bridge 转自：https://segmentfault.com/a/1190000009491002 继前两篇介绍了tun/tap和veth之后，本篇将介绍Linux下常用的一种虚拟网络设备，那就是bridge(桥)。 本篇将通过实际的例子来一步一步解释bridge是如何工作的。 什么是bridge？ 首先，bridge是..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-04-19T06:16:02.000Z"}],["meta",{"property":"article:modified_time","content":"2025-04-19T06:16:02.000Z"}]]},"git":{"createdTime":1691939318000,"updatedTime":1745043362000,"contributors":[{"name":"Paper-Dragon","username":"Paper-Dragon","email":"2678885646@qq.com","commits":1,"url":"https://github.com/Paper-Dragon"},{"name":"PaperDragon-SH","username":"PaperDragon-SH","email":"2678885646@qq.com","commits":3,"url":"https://github.com/PaperDragon-SH"},{"name":"PaperDragon","username":"PaperDragon","email":"2678885646@qq.com","commits":1,"url":"https://github.com/PaperDragon"}],"changelog":[{"hash":"0301bead570bdab0574058358a0aa0ba02960a8c","time":1745043362000,"email":"2678885646@qq.com","author":"PaperDragon","message":"清理死链"},{"hash":"d6ac4a6a6d047dec32f09cb26c03cf826736a81b","time":1716950695000,"email":"2678885646@qq.com","author":"PaperDragon-SH","message":"Openresty和lua脚本实战"},{"hash":"607ebb0d8018e2f5da17fcad6300af4a8917c749","time":1710926341000,"email":"2678885646@qq.com","author":"PaperDragon-SH","message":"111111"},{"hash":"59f93f47613439a10abfb7060f7de655983c7fb9","time":1706147919000,"email":"2678885646@qq.com","author":"PaperDragon-SH","message":"fixed url encode conflict with wordcloud error"},{"hash":"392a519398b2e846f316619fbe831e100164de7c","time":1691939318000,"email":"2678885646@qq.com","author":"Paper-Dragon","message":"Create The Worid!"}]},"readingTime":{"minutes":13.36,"words":4007},"filePathRelative":"note-book/OperaSystems/Linux虚拟网络设备之bridge.md","excerpt":"\\n<p>转自：<a href=\\"https://segmentfault.com/a/1190000009491002\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://segmentfault.com/a/1190000009491002</a></p>\\n<p>继前两篇介绍了<a href=\\"https://segmentfault.com/a/1190000009249039\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">tun/tap</a>和<a href=\\"https://segmentfault.com/a/1190000009251098\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">veth</a>之后，本篇将介绍Linux下常用的一种虚拟网络设备，那就是bridge(桥)。</p>","autoDesc":true}');export{p as comp,d as data};
