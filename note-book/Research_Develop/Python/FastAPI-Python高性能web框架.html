<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    
    <!-- æ·»åŠ ç™¾åº¦æœç´¢éªŒè¯ä»£ç  -->
    <meta name="baidu-site-verification" content="codeva-udZGoBkoXj" />
    <!-- end æ·»åŠ ç™¾åº¦æœç´¢éªŒè¯ä»£ç  -->
    
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶","image":[""],"dateModified":"2024-03-19T07:56:45.000Z","author":[{"@type":"Person","name":"Paper-Dragon","url":"https://github.com/Paper-Dragon","email":"2678885646@qq.com"}]}</script><meta property="og:url" content="https://www.geekery.cn/note-book/Research_Develop/Python/FastAPI-Python%E9%AB%98%E6%80%A7%E8%83%BDweb%E6%A1%86%E6%9E%B6.html"><meta property="og:site_name" content="è¿ç»´å¼€å‘ç»¿çš®ä¹¦"><meta property="og:title" content="FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶"><meta property="og:description" content="FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶ https://github.com/Paper-Dragon/learn-fastapi https://www.bilibili.com/video/BV1iN411X72b ç¬¬2ç«  FastAPIä»‹ç»å’Œé¡¹ç›®å‡†å¤‡ 2.1 Starletteï¼ŒPydantic ä¸ FastAPI æ¡†æ¶æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ py..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-19T07:56:45.000Z"><meta property="article:modified_time" content="2024-03-19T07:56:45.000Z"><script>
      /*ç¦ç”¨F12*/
      document.onkeydown = function(){
          if(window.event.keyCode==123) {
              var x;
              var r=confirm('å¤§ä½¬ï¼Œåˆ«æ‰’äº†ï¼ä¸å¦¨åŠ ä¸ªå‹é“¾ï¼Ÿ\nç‚¹å‡»ç¡®è®¤é”®è·³è½¬åˆ°å‹é“¾ï¼\n\næ‰§æ„è¦åšï¼Ÿäº¦æˆ–æ˜¯åŒå‡»F12å¯è°ƒå‡ºæ§åˆ¶å°\n');
              if (r==true){
                //x="ä½ æŒ‰ä¸‹çš„æ˜¯\"ç¡®å®š\"æŒ‰é’®ã€‚";
                window.location.replace("/about/friend.html");
              }
              else{
                x="ä½ æŒ‰ä¸‹çš„æ˜¯\"å–æ¶ˆ\"æŒ‰é’®ã€‚";
              }
              // document.write(x)
              event.preventDefault(); // é˜»æ­¢é»˜è®¤äº‹ä»¶è¡Œä¸º
              event.keyCode=0;
              event.returnValue=false;
          }
      }
      </script><link rel="alternate" type="application/rss+xml" href="https://www.geekery.cn/rss.xml" title="è¿ç»´å¼€å‘ç»¿çš®ä¹¦ RSS Feed"><title>FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶ | è¿ç»´å¼€å‘ç»¿çš®ä¹¦</title><meta name="description" content="FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶ https://github.com/Paper-Dragon/learn-fastapi https://www.bilibili.com/video/BV1iN411X72b ç¬¬2ç«  FastAPIä»‹ç»å’Œé¡¹ç›®å‡†å¤‡ 2.1 Starletteï¼ŒPydantic ä¸ FastAPI æ¡†æ¶æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ py...">
    <link rel="preload" href="/assets/style-BNACT-_S.css" as="style"><link rel="stylesheet" href="/assets/style-BNACT-_S.css">
    <link rel="modulepreload" href="/assets/app-Cf8kexEb.js"><link rel="modulepreload" href="/assets/FastAPI-Pythoné«˜æ€§èƒ½webæ¡†æ¶.html-YGyWYKaE.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="å¸¦æˆ‘å›å®¶"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">è¿ç»´å¼€å‘ç»¿çš®ä¹¦</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="ä¸»é¡µ"><!--[--><iconify-icon class="vp-icon" icon="line-md:home-twotone" sizing="height" height="1em"></iconify-icon><!--]-->ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/note-book/" aria-label="ä½¿ç”¨æŒ‡å—"><!--[--><iconify-icon class="vp-icon" icon="openmoji:light-bulb" sizing="height" height="1em"></iconify-icon><!--]-->ä½¿ç”¨æŒ‡å—<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="å…è´¹æœåŠ¡"><!--[--><iconify-icon class="vp-icon" icon="solar:box-line-duotone" sizing="height" height="1em"></iconify-icon>å…è´¹æœåŠ¡<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/base64.html" aria-label="Base64åœ¨çº¿ç¼–ç è§£ç "><!--[--><iconify-icon class="vp-icon" icon="streamline:device-database-encryption-1-solid" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Base64åœ¨çº¿ç¼–ç è§£ç <!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/cloudflare-warp.html" aria-label="Cloudflare Warp å›¢é˜ŸæœåŠ¡"><!--[--><iconify-icon class="vp-icon" icon="simple-icons:cloudflare" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Cloudflare Warp å›¢é˜ŸæœåŠ¡<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/code-diff.html" aria-label="ä»£ç å·®å¼‚å¯¹æ¯”"><!--[--><iconify-icon class="vp-icon" icon="icon-park-twotone:difference-set" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->ä»£ç å·®å¼‚å¯¹æ¯”<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/cron.html" aria-label="Cronåœ¨çº¿è¡¨è¾¾å¼ç”Ÿæˆå™¨"><!--[--><iconify-icon class="vp-icon" icon="eos-icons:cronjob" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Cronåœ¨çº¿è¡¨è¾¾å¼ç”Ÿæˆå™¨<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/docker-hub-mirror.html" aria-label="DockerHubé•œåƒåŠ é€Ÿ"><!--[--><iconify-icon class="vp-icon" icon="grommet-icons:docker" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->DockerHubé•œåƒåŠ é€Ÿ<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/github-direct.html" aria-label="GitHubåŠ é€Ÿä¸‹è½½"><!--[--><iconify-icon class="vp-icon" icon="mdi:github" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->GitHubåŠ é€Ÿä¸‹è½½<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/nvidia-mirror.html" aria-label="Nvidiaé•œåƒç«™"><!--[--><iconify-icon class="vp-icon" icon="bi:nvidia" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Nvidiaé•œåƒç«™<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/radeon-mirror.html" aria-label="Radeoné•œåƒç«™"><!--[--><iconify-icon class="vp-icon" icon="bi:amd" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Radeoné•œåƒç«™<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/random-password.html" aria-label="å¯†ç ç”Ÿæˆå™¨"><!--[--><iconify-icon class="vp-icon" icon="ph:password" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->å¯†ç ç”Ÿæˆå™¨<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/SSLGenerate.html" aria-label="SSL è¯ä¹¦ç”Ÿæˆ"><!--[--><iconify-icon class="vp-icon" icon="ph:certificate-duotone" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->SSL è¯ä¹¦ç”Ÿæˆ<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/text-reverse.html" aria-label="æ–‡æœ¬å­—ç¬¦ä¸²å€’åº"><!--[--><iconify-icon class="vp-icon" icon="system-uicons:reverse-alt" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->æ–‡æœ¬å­—ç¬¦ä¸²å€’åº<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/free-service/tools.html" aria-label="å°å·¥å…·"><!--[--><iconify-icon class="vp-icon" icon="material-symbols-light:tools-ladder" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->å°å·¥å…·<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æˆ‘çš„é¡¹ç›®"><!--[--><iconify-icon class="vp-icon" icon="openmoji:man-technologist" sizing="height" height="1em"></iconify-icon>æˆ‘çš„é¡¹ç›®<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/Chiptune/" aria-label="Chiptune"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:music" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->Chiptune<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/MobaXterm-Cracker/" aria-label="Mobaxterm Crack"><!--[--><img class="vp-icon" src="/MobaXterm-Cracker/README.assets/xterm_logo.png" alt aria-hidden no-view sizing="both" width="1em" height="1em"><!--]-->Mobaxterm Crack<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/projects.html" aria-label="å…¶ä»–é¡¹ç›®"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:folder" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->å…¶ä»–é¡¹ç›®<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/timeline/" aria-label="æ—¶é—´çº¿"><!--[--><iconify-icon class="vp-icon" icon="ic:twotone-view-timeline" sizing="height" height="1em"></iconify-icon><!--]-->æ—¶é—´çº¿<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/about/friend.html" aria-label="å‹é“¾"><!--[--><iconify-icon class="vp-icon" icon="fa-solid:user-friends" sizing="height" height="1em"></iconify-icon><!--]-->å‹é“¾<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="åšå®¢è”ç›Ÿ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:comment-nodes" sizing="height" height="1em"></iconify-icon>åšå®¢è”ç›Ÿ<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://www.travellings.cn/go.html" aria-label="å¼€å¾€" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="vp-icon" icon="fa:subway" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->å¼€å¾€<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://webteleporter.top" aria-label="WebTeleporter" rel="noopener noreferrer" target="_blank"><!--[--><img class="vp-icon" src="https://webteleporter.top/favicon.ico" alt aria-hidden no-view sizing="both" width="1em" height="1em"><!--]-->WebTeleporter<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="auto-link external-link" href="https://cloudflare-cloudnative-pages.geekery.cn/" aria-label="å†…å®¹åˆ†å‘ç½‘ç»œéƒ¨ç½²çŠ¶æ€" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:hexagon-nodes-bolt" sizing="height" height="1em"></iconify-icon><!--]-->å†…å®¹åˆ†å‘<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Paper-Dragon/notebook" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><!----></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" aria-label="æœç´¢æ–‡æ¡£" aria-keyshortcuts="Control+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" class="DocSearch-Search-Icon"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key DocSearch-Button-Key--ctrl">Ctrl</kbd><kbd class="DocSearch-Button-Key DocSearch-Button-Key--pressed">K</kbd></span></button></div><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="ä¸»é¡µ"><!--[--><iconify-icon class="vp-icon" icon="line-md:home-twotone" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->ä¸»é¡µ<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="vp-icon" icon="ic:twotone-book" sizing="both" width="1em" height="1em"></iconify-icon><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/note-book/" aria-label="note-book"><!---->note-book<!----></a><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">AI Training</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Anaconda</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Android</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Ansible</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Baidu Net Disk</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Btrfs</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Core DNS</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">CVE</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">DNS</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Docker</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Ebook</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">ELK</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Esxi</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Etcd</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Fossology</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Frp</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Git</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Gitlab</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Goaccess</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">GRUB</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">HA LVS Keepalived</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Harbor</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Iptables</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Jenkins</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Jumper Server</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Kafka</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Kubernetes</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Linux From Scratch</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Linux Opera System</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Linuxä¸‰å‰‘å®¢</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Midjourney</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Min IO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Misc</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">My SQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Nginx Open Resty</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Nodejs</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Ollama</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Open Stack</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Opera Systems</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Photo Shop</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Physical Server</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Portainer</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Prometheus</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Rabbit MQ</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Rancher</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Research Develop</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">ç®—æ³•è¯´æ˜</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">C</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Flutter</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Python</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/note-book/Research_Develop/Python/FastAPI-Python%E9%AB%98%E6%80%A7%E8%83%BDweb%E6%A1%86%E6%9E%B6.html" aria-label="FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶"><!---->FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/PyInstaller%E5%B8%A6%E9%9D%99%E6%80%81%E4%BE%9D%E8%B5%96%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85%E6%95%99%E7%A8%8B.html" aria-label="PyInstaller å¸¦é™æ€ä¾èµ–æ–‡ä»¶æ‰“åŒ…æ•™ç¨‹"><!---->PyInstaller å¸¦é™æ€ä¾èµ–æ–‡ä»¶æ‰“åŒ…æ•™ç¨‹<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/python%20re.html" aria-label="reåº“ç”¨æ³•ç»†è®²"><!---->reåº“ç”¨æ³•ç»†è®²<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/python%20re.Match%20object%E7%9A%84%E8%AF%B4%E6%98%8E.html" aria-label="re.match()åˆ°åº•ä¼šè¿”å›ä»€ä¹ˆ?"><!---->re.match()åˆ°åº•ä¼šè¿”å›ä»€ä¹ˆ?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E4%B9%8B%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%BB%86%E8%AE%B2.html" aria-label="Pythonä¹‹æ­£åˆ™è¡¨è¾¾å¼ç»†è®²"><!---->Pythonä¹‹æ­£åˆ™è¡¨è¾¾å¼ç»†è®²<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E4%BB%A3%E7%A0%81%E8%97%8F%E6%AF%92.html" aria-label="Pythonä»£ç è—æ¯’"><!---->Pythonä»£ç è—æ¯’<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Pythonå…¨èƒ½è¯¾ä»¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E5%AE%9E%E7%8E%B0%E4%B8%89%E7%9B%AE%E8%BF%90%E7%AE%97%E7%AC%A6.html" aria-label="Pythonå®ç°ä¸‰ç›®è¿ç®—ç¬¦"><!---->Pythonå®ç°ä¸‰ç›®è¿ç®—ç¬¦<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E5%AE%9E%E7%8E%B0%E4%B9%9D%E4%B9%9D%E4%B9%98%E6%B3%95%E8%A1%A8.html" aria-label="Pythonå®ç°ä¹ä¹ä¹˜æ³•è¡¨"><!---->Pythonå®ç°ä¹ä¹ä¹˜æ³•è¡¨<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E6%95%B0%E6%8D%AE%E5%88%87%E7%89%87%E4%BE%8B%E5%AD%90.html" aria-label="æ•°æ®åˆ‡ç‰‡"><!---->æ•°æ®åˆ‡ç‰‡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Python%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%8C%96format.html" aria-label="Pythonæ•°æ®æ ¼å¼åŒ–format"><!---->Pythonæ•°æ®æ ¼å¼åŒ–format<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Pythoné¢å‘å¯¹è±¡</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/Uvicorn%E4%BF%AE%E6%94%B9headers%E5%86%85%E7%9A%84server%E5%90%8D%E5%AD%97.html" aria-label="Uvicornä¿®æ”¹headerså†…çš„serveråå­—"><!---->Uvicornä¿®æ”¹headerså†…çš„serveråå­—<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/note-book/Research_Develop/Python/%E6%96%B0%E7%89%88VSCode%E4%B8%ADPython%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E5%87%BD%E6%95%B0%E6%8B%AC%E5%8F%B7.html" aria-label="æ–°ç‰ˆVSCodeä¸­Pythonè®¾ç½®è‡ªåŠ¨è¡¥å…¨å‡½æ•°æ‹¬å·"><!---->æ–°ç‰ˆVSCodeä¸­Pythonè®¾ç½®è‡ªåŠ¨è¡¥å…¨å‡½æ•°æ‹¬å·<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Shell</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Router OS</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Security</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Ssh</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">SSL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Tomcat</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Traefik</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Vim</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Virtual Private Network</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">VMware</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Vue</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Windows</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">WSL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Zabbix</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">äº¤æ¢æœº</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">å¸åœˆçš„é‚£äº›äº‹</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æœåŠ¡å™¨</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æ´‹åƒåœ¾ä¸»æœº</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">ç”Ÿæ´»</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="ic:twotone-book" sizing="both" width="1em" height="1em"></iconify-icon><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/PyQt5%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-%E7%8E%8B%E9%93%AD%E4%B8%9C/" aria-label="PyQt5å¿«é€Ÿä¸Šæ‰‹-ç‹é“­ä¸œ"><!---->PyQt5å¿«é€Ÿä¸Šæ‰‹-ç‹é“­ä¸œ<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="ic:twotone-book" sizing="both" width="1em" height="1em"></iconify-icon><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/ostep-note/" aria-label="Operating Systems: Three Easy Pieces å­¦ä¹ ç¬”è®°"><!---->Operating Systems: Three Easy Pieces å­¦ä¹ ç¬”è®°<!----></a><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/Paper-Dragon" target="_blank" rel="noopener noreferrer">Paper-Dragon</a></span><span property="author" content="Paper-Dragon"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2023/8/13</span><meta property="datePublished" content="2023-08-13T15:08:38.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon" name="eye"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/note-book/Research_Develop/Python/FastAPI-Python%E9%AB%98%E6%80%A7%E8%83%BDweb%E6%A1%86%E6%9E%B6.html" data-page-key="/note-book/Research_Develop/Python/FastAPI-Python%E9%AB%98%E6%80%A7%E8%83%BDweb%E6%A1%86%E6%9E%B6.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 21 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT21M"></span><!----><!----></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="fastapi-pythoné«˜æ€§èƒ½webæ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#fastapi-pythoné«˜æ€§èƒ½webæ¡†æ¶"><span>FastAPI--pythoné«˜æ€§èƒ½webæ¡†æ¶</span></a></h1><blockquote><p>https://github.com/Paper-Dragon/learn-fastapi</p><p>https://www.bilibili.com/video/BV1iN411X72b</p></blockquote><h2 id="ç¬¬2ç« -fastapiä»‹ç»å’Œé¡¹ç›®å‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#ç¬¬2ç« -fastapiä»‹ç»å’Œé¡¹ç›®å‡†å¤‡"><span>ç¬¬2ç«  FastAPIä»‹ç»å’Œé¡¹ç›®å‡†å¤‡</span></a></h2><h3 id="_2-1-starlette-pydantic-ä¸-fastapi-æ¡†æ¶æ˜¯ä»€ä¹ˆå…³ç³»" tabindex="-1"><a class="header-anchor" href="#_2-1-starlette-pydantic-ä¸-fastapi-æ¡†æ¶æ˜¯ä»€ä¹ˆå…³ç³»"><span>2.1 Starletteï¼ŒPydantic ä¸ FastAPI æ¡†æ¶æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</span></a></h3><p>pythonçš„ç±»å‹æç¤ºï¼ŒåŸºäºç±»å‹æç¤ºtype hints</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from typing import List</span></span>
<span class="line"><span>def func(name:str,age:int,l:List):</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    print(name,age)</span></span>
<span class="line"><span>    print(l)    </span></span>
<span class="line"><span># Pythonçš„ç±»å‹æç¤ºä½¿ç”¨æ–¹æ³•ï¼Œä½¿ç”¨çš„å¥½èƒ½å¤Ÿæé«˜ä»£ç çš„å¥å£®æ€§</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Pydanticæ˜¯ä¸€ä¸ªåŸºäºPythonç±»å‹æç¤ºæ¥å®šä¹‰æ•°æ®éªŒè¯ï¼Œåºåˆ—åŒ–å’Œæ–‡æ¡£ï¼ˆä½¿ç”¨JSONæ¨¡å¼ï¼‰åº“</p><p>Starletteæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ASGIæ¡†æ¶/å·¥å…·åŒ…ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½AsyncioæœåŠ¡çš„ç†æƒ³é€‰æ‹©</p><p><img src="/assets/2ab113f5bbfc49a9befae75e5d06fa08tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-DL-T3p8X.webp" alt="image-20210202092756107"></p><p>å®‰è£…ç¯å¢ƒï¼Œpythonç¯å¢ƒå¿…é¡»æ˜¯3.6ä»¥ä¸Šçš„ï¼Œç„¶åå»githubä¸­å°†<a href="https://github.com/liaogx/fastapi-tutorial" target="_blank" rel="noopener noreferrer">github.com/liaogx/fastapi-tutorial</a> æ‹·è´ä¸‹æ¥ï¼Œå®‰è£…reqiurements.txté‡Œé¢çš„åŒ…</p><p>ä¸€å®šè¦æ³¨æ„ç‰ˆæœ¬çš„å…¼å®¹æ€§</p><h3 id="_2-2-pydanticåŸºç¡€æ•™ç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-2-pydanticåŸºç¡€æ•™ç¨‹"><span>2.2 PydanticåŸºç¡€æ•™ç¨‹</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>Data validation and settings management using python type annotations.</span></span>
<span class="line"><span>ä½¿ç”¨Pythonçš„ç±»å‹æ³¨è§£æ¥è¿›è¡Œæ•°æ®æ ¡éªŒå’Œsettingsç®¡ç†</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pydantic enforces type hints at runtime, and provides user friendly errors when data is invalid.</span></span>
<span class="line"><span>Pydanticå¯ä»¥åœ¨ä»£ç è¿è¡Œæ—¶æä¾›ç±»å‹æç¤ºï¼Œæ•°æ®æ ¡éªŒå¤±è´¥æ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤º</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Define how data should be in pure, canonical python; validate it with pydantic.</span></span>
<span class="line"><span>å®šä¹‰æ•°æ®åº”è¯¥å¦‚ä½•åœ¨çº¯è§„èŒƒçš„Pythonä»£ç ä¸­ä¿å­˜ï¼Œå¹¶ç”¨PydanticéªŒè¯å®ƒ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from typing import List</span></span>
<span class="line"><span>from datetime import datetime</span></span>
<span class="line"><span>from pydantic import BaseModel</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å¦‚æœç±»çš„å±æ€§ä¸­æœ‰é»˜è®¤å€¼æ˜¯é€‰å¡«ï¼Œæ²¡æœ‰é»˜è®¤å€¼å°±æ˜¯å¿…å¡«çš„</span></span>
<span class="line"><span>class User(BaseModel):</span></span>
<span class="line"><span>    id = int</span></span>
<span class="line"><span>    name: str = &quot;andy&quot;</span></span>
<span class="line"><span>    signup_list: datetime</span></span>
<span class="line"><span>    friends: List[int] = []</span></span>
<span class="line"><span></span></span>
<span class="line"><span>external_data = {</span></span>
<span class="line"><span>    &quot;id&quot;: 1,</span></span>
<span class="line"><span>    &quot;signup_list&quot;: &quot;2021-02-02 10:10&quot;,</span></span>
<span class="line"><span>    &quot;friends&quot;:[1, 2, &quot;3&quot;]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>user = User(**external_data)</span></span>
<span class="line"><span>print(user.name)</span></span>
<span class="line"><span>print(user.friends)</span></span>
<span class="line"><span>print(repr(user.signup_list))</span></span>
<span class="line"><span>print(user.dict())  # ä»¥å­—å…¸çš„æ ¼å¼è¾“å‡º</span></span>
<span class="line"><span>print(user.json())  # ä»¥jsonçš„æ ¼å¼è¾“å‡º</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># class People(User):</span></span>
<span class="line"><span>#     def start(self):</span></span>
<span class="line"><span>#         print(f&quot;æˆ‘çš„åå­—{self.name}&quot;)</span></span>
<span class="line"><span>#     def friend(self):</span></span>
<span class="line"><span>#         print(f&quot;æˆ‘çš„æœ‹å‹ä»¬{str(self.friends)}&quot;)</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span># people = People(**external_data)</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span># people.start()</span></span>
<span class="line"><span># people.friend()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>pycharmå®‰è£…pydanticæ’ä»¶</strong> <img src="/assets/6474dac09c9f4e9584cb52f4369659dftplv-k3u1fbpfcp-zoom-in-crop-mark4536000-tDlWiIIW.webp" alt=" image-20210202100216847 "></p><p><strong>æ ¡éªŒå¤±è´¥çš„å¤„ç†</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># æ ¡éªŒå¤±è´¥çš„å¤„ç†</span></span>
<span class="line"><span>try:</span></span>
<span class="line"><span>    User(id=1,signup_list=datetime.today(),friends=[1,2,&#39;hello world&#39;])</span></span>
<span class="line"><span>except ValidationError as e:</span></span>
<span class="line"><span>    print(e.json())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°çš„ç»“æœ</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>[</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    &quot;loc&quot;: [</span></span>
<span class="line"><span>      &quot;friends&quot;,</span></span>
<span class="line"><span>      2</span></span>
<span class="line"><span>    ],</span></span>
<span class="line"><span>    &quot;msg&quot;: &quot;value is not a valid integer&quot;,</span></span>
<span class="line"><span>    &quot;type&quot;: &quot;type_error.integer&quot;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ¨¡å‹ç±»çš„å±æ€§å’Œæ–¹æ³•</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>print(user.dict())</span></span>
<span class="line"><span>print(user.json())</span></span>
<span class="line"><span>print(user.copy())  # è¿™é‡Œæ˜¯æµ…æ‹·è´</span></span>
<span class="line"><span>print(User.parse_obj(external_data))</span></span>
<span class="line"><span>print(User.parse_raw(&#39;{&quot;id&quot;: &quot;123&quot;, &quot;signup_ts&quot;: &quot;2020-12-22 12:22&quot;, &quot;friends&quot;: [1, 2, &quot;3&quot;]}&#39;))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>path = Path(&#39;pydantic_tutorial.json&#39;)</span></span>
<span class="line"><span>path.write_text(&#39;{&quot;id&quot;: &quot;123&quot;, &quot;signup_ts&quot;: &quot;2020-12-22 12:22&quot;, &quot;friends&quot;: [1, 2, &quot;3&quot;]}&#39;)</span></span>
<span class="line"><span>print(User.parse_file(path))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>print(user.schema())</span></span>
<span class="line"><span>print(user.schema_json())</span></span>
<span class="line"><span></span></span>
<span class="line"><span>user_data = {&quot;id&quot;: &quot;error&quot;, &quot;signup_ts&quot;: &quot;2020-12-22 12 22&quot;, &quot;friends&quot;: [1, 2, 3]}  # idæ˜¯å­—ç¬¦ä¸² æ˜¯é”™è¯¯çš„</span></span>
<span class="line"><span>print(User.construct(**user_data))  # ä¸æ£€éªŒæ•°æ®ç›´æ¥åˆ›å»ºæ¨¡å‹ç±»ï¼Œä¸å»ºè®®åœ¨constructæ–¹æ³•ä¸­ä¼ å…¥æœªç»éªŒè¯çš„æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>print(User.__fields__.keys())  # å®šä¹‰æ¨¡å‹ç±»çš„æ—¶å€™ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ³¨æ˜ç±»å‹ï¼Œå­—æ®µé¡ºåºå°±ä¸ä¼šä¹±</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é€’å½’æ¨¡å‹</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>class Sound(BaseModel):</span></span>
<span class="line"><span>    sound: str</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Dog(BaseModel):</span></span>
<span class="line"><span>    birthday: date</span></span>
<span class="line"><span>    weight: float = Optional[None]</span></span>
<span class="line"><span>    sound: List[Sound]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>dogs = Dog(birthday=date.today(),weight=9.99,sound=[{&quot;sound&quot;:&quot;wang wang~&quot;},{&quot;sound&quot;: &quot;ying ying ~&quot;}])</span></span>
<span class="line"><span>print(dogs.json())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œç»“æœ</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>{&quot;birthday&quot;: &quot;2021-02-02&quot;, &quot;sound&quot;: [{&quot;sound&quot;: &quot;wang wang~&quot;}, {&quot;sound&quot;: &quot;ying ying ~&quot;}]}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ORMæ¨¡å‹ï¼Œä»ç±»å®ä¾‹åˆ›å»ºç¬¦åˆORMå¯¹è±¡çš„æ¨¡å‹</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from sqlalchemy.dialects.postgresql import ARRAY</span></span>
<span class="line"><span>from sqlalchemy.ext.declarative import declarative_base</span></span>
<span class="line"><span>from sqlalchemy import Integer, String, Column</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Base = declarative_base()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CompanyOrm(Base):</span></span>
<span class="line"><span>    __tablename__ = &#39;companies&#39;</span></span>
<span class="line"><span>    id =Column(Integer, primary_key=True, nullable=True)</span></span>
<span class="line"><span>    public_key = Column(String(20), index=True, nullable=False, unique=True)</span></span>
<span class="line"><span>    name = Column(String(100), unique=True)</span></span>
<span class="line"><span>    domains = Column(ARRAY(String(255)))</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CompanyModel(BaseModel):</span></span>
<span class="line"><span>    id: int</span></span>
<span class="line"><span>    public_key: constr(max_length=20)</span></span>
<span class="line"><span>    name: constr(max_length=100)</span></span>
<span class="line"><span>    domains: List[constr(max_length=255)]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    class Config:</span></span>
<span class="line"><span>        orm_mode = True</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>co_orm = CompanyOrm(</span></span>
<span class="line"><span>    id=1,</span></span>
<span class="line"><span>    public_key=&quot;akey&quot;,</span></span>
<span class="line"><span>    name=&quot;andy&quot;,</span></span>
<span class="line"><span>    domains=[&#39;123.com&#39;, &#39;456.com&#39;]</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>print(CompanyModel.from_orm(co_orm))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¬¬3ç« -è¯·æ±‚å‚æ•°å’ŒéªŒè¯" tabindex="-1"><a class="header-anchor" href="#ç¬¬3ç« -è¯·æ±‚å‚æ•°å’ŒéªŒè¯"><span>ç¬¬3ç« ï¼šè¯·æ±‚å‚æ•°å’ŒéªŒè¯</span></a></h2><h3 id="_3-1fastapiçš„ç®€å•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_3-1fastapiçš„ç®€å•ä½¿ç”¨"><span>3.1fastapiçš„ç®€å•ä½¿ç”¨</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from typing import Optional</span></span>
<span class="line"><span>from fastapi import FastAPI</span></span>
<span class="line"><span>from pydantic import BaseModel</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app = FastAPI()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class People(BaseModel):</span></span>
<span class="line"><span>    id: int</span></span>
<span class="line"><span>    name: str</span></span>
<span class="line"><span>    addr: Optional[str] = None</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app.get(&#39;/&#39;)</span></span>
<span class="line"><span>async def person():</span></span>
<span class="line"><span>    return {&quot;name&quot;: &quot;hello world&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app.get(&#39;/city/{city}&#39;)</span></span>
<span class="line"><span>async def result(city: str, query_str: Optional[str] = None):</span></span>
<span class="line"><span>    return {&#39;city&#39;: city, &#39;query_str&#39;: query_str}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app.post(&#39;/person/{person}&#39;)</span></span>
<span class="line"><span>async def result(person: str, city_info: People):</span></span>
<span class="line"><span>    return {&quot;person&quot;: person, &quot;id&quot;: city_info.id, &#39;name&#39;: city_info.name, &#39;addr&#39;: city_info.addr}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># é¡¹ç›®çš„å¯åŠ¨</span></span>
<span class="line"><span>uvicorn æ–‡ä»¶å:app --reload</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ¥å£æ–‡æ¡£çš„ç”Ÿæˆ</span></span>
<span class="line"><span>localhost:8000/docs</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å±•ç¤ºæ¥å£çš„æ¥å£</span></span>
<span class="line"><span>localhost:8000/redoc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-fastapiçš„ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_3-2-fastapiçš„ç»“æ„"><span>3.2 fastApiçš„ç»“æ„</span></a></h3><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶åŒ…ï¼Œç”¨äºå­˜æ”¾å„ä¸ªapp <img src="/assets/0093421e41164cadaa99f7c6cff38cdbtplv-k3u1fbpfcp-zoom-in-crop-mark4536000-BrBNZBVX.webp" alt=" image-20210202145110225"></p><p>ç„¶åå†<strong>chapter03.py</strong>ä¸­å®ç°</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from enum import Enum</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from fastapi import APIRouter</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app03 = APIRouter()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä»–appä¸€æ ·çš„æ“ä½œ</p><p>åœ¨<em><strong>inif</strong>.py</em>æ–‡ä»¶ä¸­</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from .chapter03 import app03</span></span>
<span class="line"><span>from .chapter04 import app04</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨run.pyæ–‡ä»¶ä¸­</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>import uvicorn</span></span>
<span class="line"><span>from fastapi import FastAPI</span></span>
<span class="line"><span>from tutorial import app03</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app = FastAPI()</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å°†appçš„å­åº”ç”¨é›†æˆè¿›æ¥</span></span>
<span class="line"><span>app.include_router(app03, prefix=&#39;/chapter03&#39;, tags=[&#39;ç¬¬ä¸‰ç« ï¼Œè¯·æ±‚å‚æ•°å’ŒéªŒè¯&#39;])</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>if __name__ == &#39;__main__&#39;:</span></span>
<span class="line"><span>    uvicorn.run(&#39;run:app&#39;,host=&#39;0.0.0.0&#39;,port=8000,reload=True,debug=True,workers=1)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from enum import Enum</span></span>
<span class="line"><span>from typing import Optional, List</span></span>
<span class="line"><span>from fastapi import APIRouter, Query, Cookie, Header</span></span>
<span class="line"><span>from pydantic import BaseModel, Field</span></span>
<span class="line"><span>from datetime import date</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app03 = APIRouter()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Path Parameters and Number Validations è·¯å¾„å‚æ•°å’Œæ•°å­—éªŒè¯&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/path/parameters&#39;)</span></span>
<span class="line"><span>def path_params01():</span></span>
<span class="line"><span>    return {&quot;message&quot;: &quot;This is a message&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/path/{parameters}&#39;)</span></span>
<span class="line"><span>def path_parameters02(parameters: str):</span></span>
<span class="line"><span>    return {&quot;message&quot;: parameters}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># æšä¸¾</span></span>
<span class="line"><span>class CityName(str, Enum):</span></span>
<span class="line"><span>    Beijing = &quot;Beijing china&quot;</span></span>
<span class="line"><span>    Shanghai = &quot;Shanghai china&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/enum/{city}&#39;)</span></span>
<span class="line"><span>async def latest(city: CityName):</span></span>
<span class="line"><span>    if city == CityName.Shanghai:</span></span>
<span class="line"><span>        return {&quot;city_name&quot;: city, &quot;confirmed&quot;: 1492, &quot;death&quot;: 7}</span></span>
<span class="line"><span>    elif city == CityName.Beijing:</span></span>
<span class="line"><span>        return {&#39;city_name&#39;: city, &quot;confirmed&quot;: 971, &quot;death&quot;: 9}</span></span>
<span class="line"><span>    return {&quot;city_name&quot;: city, &#39;latest&#39;: &quot;unknown&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/files/{filepath:path}&#39;)</span></span>
<span class="line"><span>def filepath(filepath: str):</span></span>
<span class="line"><span>    return f&quot;This file path is {filepath}&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Query Parameters and String Validations æŸ¥è¯¢å‚æ•°å’Œå­—ç¬¦ä¸²éªŒè¯&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/query&#39;)</span></span>
<span class="line"><span>def page_limit(page: int = 1, limit: Optional[int] = None):</span></span>
<span class="line"><span>    if limit:</span></span>
<span class="line"><span>        return {&#39;page&#39;: page, &#39;limit&#39;: limit}</span></span>
<span class="line"><span>    else:</span></span>
<span class="line"><span>        return {&quot;page&quot;: page}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&#39;/query/bool/conversion&#39;)  # boolç±»å‹è½¬æ¢ï¼šyes on 1 True trueä¼šè½¬æ¢æˆtrue, å…¶å®ƒä¸ºfalse</span></span>
<span class="line"><span>def query_params_validate(query: bool = False):</span></span>
<span class="line"><span>    return f&quot;è¿”å›çš„æ•°æ®æ˜¯{query}&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&quot;/query/validations&quot;)</span></span>
<span class="line"><span>def query_params_validate(</span></span>
<span class="line"><span>        value: str = Query(..., min_length=8, max_length=16, regex=&quot;^a&quot;),</span></span>
<span class="line"><span>        values: List[str] = Query([&#39;V1&#39;, &#39;V2&#39;], alias=&quot;alias_name&quot;)</span></span>
<span class="line"><span>):</span></span>
<span class="line"><span>    return value, values</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Request Body and Fields è¯·æ±‚ä½“å’Œå­—æ®µ&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CityInfo(BaseModel):</span></span>
<span class="line"><span>    name: str = Field(..., example=&quot;Beijing&quot;)  # exampleæ˜¯æ³¨è§£çš„ä½œç”¨ï¼Œå€¼ä¸ä¼šè¢«éªŒè¯</span></span>
<span class="line"><span>    country: str</span></span>
<span class="line"><span>    country_code: str = None  # ç»™ä¸€ä¸ªé»˜è®¤å€¼</span></span>
<span class="line"><span>    country_population: int = Field(default=800, title=&quot;äººå£æ•°é‡&quot;, description=&quot;å›½å®¶çš„äººå£æ•°é‡&quot;, ge=800)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    class Config:</span></span>
<span class="line"><span>        schema_extra = {</span></span>
<span class="line"><span>            &quot;example&quot;: {</span></span>
<span class="line"><span>                &quot;name&quot;: &quot;Shanghai&quot;,</span></span>
<span class="line"><span>                &quot;country&quot;: &quot;China&quot;,</span></span>
<span class="line"><span>                &quot;country_code&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span>                &quot;country_population&quot;: 1400000000,</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.post(&quot;/request_body/city&quot;)</span></span>
<span class="line"><span>def city_info(city: CityInfo):</span></span>
<span class="line"><span>    print(city.name, city.country)  # å½“åœ¨IDEä¸­è¾“å…¥city.çš„æ—¶å€™ï¼Œå±æ€§ä¼šè‡ªåŠ¨å¼¹å‡º</span></span>
<span class="line"><span>    return city.dict()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Request Body - Nested Nodels æ•°æ®æ ¼å¼åµŒå¥—çš„è¯·æ±‚ä½“&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Data(BaseModel):</span></span>
<span class="line"><span>    city: List[CityInfo] = None</span></span>
<span class="line"><span>    date: date</span></span>
<span class="line"><span>    confirmed: int = Field(ge=0, description=&quot;ç¡®è¯Šæ•°&quot;, default=0)</span></span>
<span class="line"><span>    deaths: int = Field(ge=0, description=&quot;æ­»äº¡æ•°&quot;, default=0)</span></span>
<span class="line"><span>    recovered: int = Field(ge=0, description=&quot;ç—Šæ„ˆæ•°&quot;, default=0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.put(&#39;/request_body/nested&#39;)</span></span>
<span class="line"><span>def nested_models(data: Data):</span></span>
<span class="line"><span>    return data</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;å¦‚ä½•è®¾ç½®Cookieå’ŒHeaderå‚æ•°&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&quot;/cookie&quot;)  # è¿™ä¸ªåªèƒ½ç”¨postmanæµ‹è¯•ï¼Œåœ¨Headerä¸­æ·»åŠ Cookie = cookie_id=xxx</span></span>
<span class="line"><span># å®šä¹‰Cookieå‚æ•°éœ€è¦ä½¿ç”¨Cookieç±»ï¼Œå¦åˆ™å°±æ˜¯æŸ¥è¯¢å‚æ•°</span></span>
<span class="line"><span>def cookie(cookie_id: Optional[str] = Cookie(None)):</span></span>
<span class="line"><span>    return cookie_id</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app03.get(&quot;/header&quot;)</span></span>
<span class="line"><span>def header(user_agent: Optional[str] = Header(None, convert_underscores=True), x_token: List[str] = Header(None)):</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    æœ‰äº›HTTPä»£ç†å’ŒæœåŠ¡å™¨æ˜¯ä¸å…è®¸åœ¨è¯·æ±‚å¤´ä¸­å¸¦æœ‰ä¸‹åˆ’çº¿çš„ï¼Œæ‰€ä»¥Headeræä¾›convert_underscoreså±æ€§è®©è®¾ç½®</span></span>
<span class="line"><span>    :param user_agent: convert_underscores=True ä¼šæŠŠ user_agent å˜æˆ user-agent</span></span>
<span class="line"><span>    :param x_token: x_tokenæ˜¯åŒ…å«å¤šä¸ªå€¼çš„åˆ—è¡¨</span></span>
<span class="line"><span>    :return:</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    return {&quot;User-Agent&quot;: user_agent, &quot;x-Token&quot;: x_token}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŸ¥è¯¢å‚æ•°æ€»çš„æ•°æ®æ ¼å¼æ ¡éªŒä½¿ç”¨Query--from fastapi import Query</p><p>è¯·æ±‚ä½“ä¸­çš„å‚æ•°æ ¡éªŒä½¿ç”¨Field---from pydantic import Field</p><p><strong>ä½¿ç”¨pandticæ¥å®šä¹‰è¯·æ±‚ä½“æ•°æ®çš„æ—¶å€™ä½¿ç”¨Filedç±»,</strong></p><p><strong>ä½¿ç”¨è·¯å¾„å‚æ•°çš„æ—¶å€™å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒä½¿ç”¨Pathç±»ï¼Œ</strong></p><p><strong>å¯¹æŸ¥è¯¢å‚æ•°è¿›è¡Œæ ¡éªŒçš„æ—¶å€™ä½¿ç”¨Queryç±»</strong></p><h2 id="ç¬¬4ç« -å“åº”å¤„ç†å’Œfastapié…ç½®" tabindex="-1"><a class="header-anchor" href="#ç¬¬4ç« -å“åº”å¤„ç†å’Œfastapié…ç½®"><span>ç¬¬4ç«  å“åº”å¤„ç†å’ŒFastAPIé…ç½®</span></a></h2><h3 id="_4-1å“åº”æ¨¡å‹ç¤ºä¾‹ç²¾è®²" tabindex="-1"><a class="header-anchor" href="#_4-1å“åº”æ¨¡å‹ç¤ºä¾‹ç²¾è®²"><span>4-1å“åº”æ¨¡å‹ç¤ºä¾‹ç²¾è®²</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi import BaseModel</span></span>
<span class="line"><span>from pydantic import EmailStr</span></span>
<span class="line"><span>from typing import Option,List</span></span>
<span class="line"><span>&quot;&quot;&quot;4.1 Reponse Modelå“åº”æ¨¡å‹&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class UserIn(BaseModel):</span></span>
<span class="line"><span>    username: str</span></span>
<span class="line"><span>    password: str</span></span>
<span class="line"><span>    email: EmailStr</span></span>
<span class="line"><span>    mobile: str = &#39;110&#39;</span></span>
<span class="line"><span>    address: str = None</span></span>
<span class="line"><span>    full_name: Optional[str] = None</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class UserOut(BaseModel):</span></span>
<span class="line"><span>    username: str</span></span>
<span class="line"><span>    email: EmailStr</span></span>
<span class="line"><span>    mobile: str = &#39;110&#39;</span></span>
<span class="line"><span>    address: str = None</span></span>
<span class="line"><span>    full_name: Optional[str] = None</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>users = {</span></span>
<span class="line"><span>    &quot;user01&quot;: {&quot;username&quot;: &quot;user01&quot;, &quot;password&quot;: &quot;123123&quot;, &quot;email&quot;: &quot;user01@example.com&quot;},</span></span>
<span class="line"><span>    &quot;user02&quot;: {&quot;username&quot;: &quot;user02&quot;, &quot;password&quot;: &quot;123456&quot;, &quot;email&quot;: &quot;user02@example.com&quot;, &quot;mobile&quot;: &quot;110&quot;}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(&quot;/response_model&quot;, response_model=UserOut, response_model_exclude_unset=True)</span></span>
<span class="line"><span>async def response_model(user: UserIn):</span></span>
<span class="line"><span>    &quot;&quot;&quot;response_model_exclude_unset=Trueè¡¨ç¤ºé»˜è®¤å€¼ä¸åŒ…å«åœ¨å“åº”ä¸­ï¼Œä»…åŒ…å«å®é™…ç»™çš„å€¼ï¼Œå¦‚æœå®é™…ç»™çš„å€¼ä¸é»˜è®¤å€¼ç›¸åŒä¹Ÿä¼šåŒ…å«åœ¨å“åº”ä¸­&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    print(user.password)</span></span>
<span class="line"><span>    return users[&quot;user02&quot;]</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(</span></span>
<span class="line"><span>    &quot;/response_model/attributes&quot;,</span></span>
<span class="line"><span>    response_model=UserOut,  # æŒ‡å®šæ¨¡å‹ç±»</span></span>
<span class="line"><span>    # response_model=Union[UserIn, UserOut],  # è”åˆä¸¤ä¸ªæ¨¡å‹ç±»</span></span>
<span class="line"><span>    # response_model=List[UserOut],  # è¿”å›ç»“æœæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿”å›ç»“æœåŒ…å«å¤šä¸ªå“åº”æ¨¡å‹</span></span>
<span class="line"><span>    response_model_include=[&quot;username&quot;, &quot;email&quot;, &quot;mobile&quot;],  # åŒ…å«å“ªäº›å­—æ®µ</span></span>
<span class="line"><span>    response_model_exclude=[&quot;mobile&quot;]  # è¿‡æ»¤æ‰å“ªäº›å­—æ®µ</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>async def response_model_attributes(user: UserIn):</span></span>
<span class="line"><span>    &quot;&quot;&quot;response_model_includeåˆ—å‡ºéœ€è¦åœ¨è¿”å›ç»“æœä¸­åŒ…å«çš„å­—æ®µï¼›response_model_excludeåˆ—å‡ºéœ€è¦åœ¨è¿”å›ç»“æœä¸­æ’é™¤çš„å­—æ®µ&quot;&quot;&quot;</span></span>
<span class="line"><span>    # del user.password  # Union[UserIn, UserOut]åï¼Œåˆ é™¤passwordå±æ€§ä¹Ÿèƒ½è¿”å›æˆåŠŸ</span></span>
<span class="line"><span>    return user</span></span>
<span class="line"><span>    # return [user, user]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2å“åº”çŠ¶æ€ç å’Œå¿«æ·å±æ€§" tabindex="-1"><a class="header-anchor" href="#_4-2å“åº”çŠ¶æ€ç å’Œå¿«æ·å±æ€§"><span>4.2å“åº”çŠ¶æ€ç å’Œå¿«æ·å±æ€§</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi import status</span></span>
<span class="line"><span>&quot;&quot;&quot;Response Status Code å“åº”çŠ¶æ€ç &quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> </span></span>
<span class="line"><span>@app04.post(&quot;/status_code&quot;, status_code=200)</span></span>
<span class="line"><span>async def status_code():</span></span>
<span class="line"><span>    return {&quot;status_code&quot;: 200}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(&quot;/status_attribute&quot;, status_code=status.HTTP_200_OK)</span></span>
<span class="line"><span>async def status_attribute():</span></span>
<span class="line"><span>    print(type(status.HTTP_200_OK))</span></span>
<span class="line"><span>    return {&quot;status_code&quot;: status.HTTP_200_OK}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3è¡¨å•æ•°æ®å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_4-3è¡¨å•æ•°æ®å¤„ç†"><span>4.3è¡¨å•æ•°æ®å¤„ç†</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi import Form, File, UploadFile</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Form Data è¡¨å•æ•°æ®å¤„ç†&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(&quot;/login/&quot;)</span></span>
<span class="line"><span>async def login(username: str = Form(...), password: str = Form(...)):  # å®šä¹‰è¡¨å•å‚æ•°</span></span>
<span class="line"><span>    &quot;&quot;&quot;ç”¨Formç±»éœ€è¦pip install python-multipart; Formç±»çš„å…ƒæ•°æ®å’Œæ ¡éªŒæ–¹æ³•ç±»ä¼¼Body/Query/Path/Cookie&quot;&quot;&quot;</span></span>
<span class="line"><span>    return {&quot;username&quot;: username}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Request Files å•æ–‡ä»¶ã€å¤šæ–‡ä»¶ä¸Šä¼ åŠå‚æ•°è¯¦è§£&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(&quot;/file&quot;)</span></span>
<span class="line"><span>async def file_(file: bytes = File(...)):  # å¦‚æœè¦ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ files: List[bytes] = File(...)</span></span>
<span class="line"><span>    &quot;&quot;&quot;ä½¿ç”¨Fileç±» æ–‡ä»¶å†…å®¹ä¼šä»¥bytesçš„å½¢å¼è¯»å…¥å†…å­˜ é€‚åˆäºä¸Šä¼ å°æ–‡ä»¶&quot;&quot;&quot;</span></span>
<span class="line"><span>    return {&quot;file_size&quot;: len(file)}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.post(&quot;/upload_files&quot;)</span></span>
<span class="line"><span>async def upload_files(files: List[UploadFile] = File(...)):  # å¦‚æœè¦ä¸Šä¼ å•ä¸ªæ–‡ä»¶ file: UploadFile = File(...)</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    ä½¿ç”¨UploadFileç±»çš„ä¼˜åŠ¿:</span></span>
<span class="line"><span>    1.æ–‡ä»¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½¿ç”¨çš„å†…å­˜è¾¾åˆ°é˜ˆå€¼åï¼Œå°†è¢«ä¿å­˜åœ¨ç£ç›˜ä¸­</span></span>
<span class="line"><span>    2.é€‚åˆäºå›¾ç‰‡ã€è§†é¢‘å¤§æ–‡ä»¶</span></span>
<span class="line"><span>    3.å¯ä»¥è·å–ä¸Šä¼ çš„æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶åï¼Œåˆ›å»ºæ—¶é—´ç­‰</span></span>
<span class="line"><span>    4.æœ‰æ–‡ä»¶å¯¹è±¡çš„å¼‚æ­¥æ¥å£</span></span>
<span class="line"><span>    5.ä¸Šä¼ çš„æ–‡ä»¶æ˜¯Pythonæ–‡ä»¶å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨write(), read(), seek(), close()æ“ä½œ</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    for file in files:</span></span>
<span class="line"><span>        contents = await file.read()</span></span>
<span class="line"><span>        print(contents)</span></span>
<span class="line"><span>    return {&quot;filename&quot;: files[0].filename, &quot;content_type&quot;: files[0].content_type}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-fastapié¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®" tabindex="-1"><a class="header-anchor" href="#_4-4-fastapié¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®"><span>4.4 FastAPIé¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># åœ¨run.pyä¸­</span></span>
<span class="line"><span>from fastapi.staticfiles import StaticFiles</span></span>
<span class="line"><span># mountè¡¨ç¤ºå°†æŸä¸ªç›®å½•ä¸‹ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„åº”ç”¨æŒ‚è½½è¿‡æ¥ï¼Œè¿™ä¸ªä¸ä¼šåœ¨APIäº¤äº’æ–‡æ¡£ä¸­æ˜¾ç¤º</span></span>
<span class="line"><span>app.mount(path=&#39;corona/static&#39;,app=StaticFiles(directory=&#39;./corona/statuic&#39;),name=&quot;static&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-fastapié¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®-1" tabindex="-1"><a class="header-anchor" href="#_4-4-fastapié¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®-1"><span>4.4 FastAPIé¡¹ç›®çš„é™æ€æ–‡ä»¶é…ç½®</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># åœ¨run.pyä¸­</span></span>
<span class="line"><span>from fastapi.staticfiles import StaticFiles</span></span>
<span class="line"><span># mountè¡¨ç¤ºå°†æŸä¸ªç›®å½•ä¸‹ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„åº”ç”¨æŒ‚è½½è¿‡æ¥ï¼Œè¿™ä¸ªä¸ä¼šåœ¨APIäº¤äº’æ–‡æ¡£ä¸­æ˜¾ç¤º</span></span>
<span class="line"><span>app.mount(path=&#39;static&#39;,app=StaticFiles(directory=&#39;./corona/statuic&#39;),name=&quot;static&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-è·¯å¾„æ“ä½œé…ç½®" tabindex="-1"><a class="header-anchor" href="#_4-5-è·¯å¾„æ“ä½œé…ç½®"><span>4.5 è·¯å¾„æ“ä½œé…ç½®</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>@app04.post(</span></span>
<span class="line"><span>    &quot;/path_operation_configuration&quot;,</span></span>
<span class="line"><span>    response_model=UserOut,  # æŒ‡å®šå“åº”æ¨¡å‹</span></span>
<span class="line"><span>    # tags=[&quot;Path&quot;, &quot;Operation&quot;, &quot;Configuration&quot;],</span></span>
<span class="line"><span>    summary=&quot;This is summary&quot;,  </span></span>
<span class="line"><span>    description=&quot;This is description&quot;,</span></span>
<span class="line"><span>    response_description=&quot;This is response description&quot;,</span></span>
<span class="line"><span>    deprecated=True,  # è¡¨ç¤ºè¯¥æ¥å£æ˜¯å¦å¯ç”¨</span></span>
<span class="line"><span>    status_code=status.HTTP_200_OK  # çŠ¶æ€ç </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>async def path_operation_configuration(user: UserIn):</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    Path Operation Configuration è·¯å¾„æ“ä½œé…ç½®</span></span>
<span class="line"><span>    :param user: ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line"><span>    :return: è¿”å›ç»“æœ</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    return user.dict()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-fastapi-åº”ç”¨çš„å¸¸è§é…ç½®é¡¹" tabindex="-1"><a class="header-anchor" href="#_4-6-fastapi-åº”ç”¨çš„å¸¸è§é…ç½®é¡¹"><span>4.6 FastAPI åº”ç”¨çš„å¸¸è§é…ç½®é¡¹</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># run.py</span></span>
<span class="line"><span>app = FastAPI(</span></span>
<span class="line"><span>    title=&#39;FastAPI Tutorial and Coronavirus Tracker API Docs&#39;,</span></span>
<span class="line"><span>    description=&#39;FastAPIæ•™ç¨‹ æ–°å† ç—…æ¯’ç–«æƒ…è·Ÿè¸ªå™¨APIæ¥å£æ–‡æ¡£ï¼Œé¡¹ç›®ä»£ç ï¼šhttps://github.com/liaogx/fastapi-tutorial&#39;,</span></span>
<span class="line"><span>    version=&#39;1.0.0&#39;,</span></span>
<span class="line"><span>    docs_url=&#39;/docs&#39;,</span></span>
<span class="line"><span>    redoc_url=&#39;/redocs&#39;,</span></span>
<span class="line"><span>)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.7 fastapiçš„å¼‚å¸¸å¤„ç†</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi.exceptions import RequestValidationError</span></span>
<span class="line"><span>from fastapi.responses import PlainTextResponse</span></span>
<span class="line"><span>from starlette.exceptions import HTTPException as StarletteHTTPException</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.get(&quot;/http_exception&quot;)</span></span>
<span class="line"><span>async def http_exception(city: str):</span></span>
<span class="line"><span>    if city != &quot;Beijing&quot;:</span></span>
<span class="line"><span>        raise HTTPException(status_code=404, detail=&quot;City not found!&quot;, headers={&quot;X-Error&quot;: &quot;Error&quot;})</span></span>
<span class="line"><span>    return {&quot;city&quot;: city}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app04.get(&quot;/http_exception/{city_id}&quot;)</span></span>
<span class="line"><span>async def override_http_exception(city_id: int):</span></span>
<span class="line"><span>    if city_id == 1:</span></span>
<span class="line"><span>        raise HTTPException(status_code=418, detail=&quot;Nope! I don&#39;t like 1.&quot;)</span></span>
<span class="line"><span>    return {&quot;city_id&quot;: city_id}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¬¬5ç« -fastapiçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ç¬¬5ç« -fastapiçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ"><span>ç¬¬5ç« ï¼šFastAPIçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ</span></a></h2><h3 id="_5-1-ä¾èµ–æ³¨å…¥ç³»ç»Ÿä»‹ç»å’Œä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_5-1-ä¾èµ–æ³¨å…¥ç³»ç»Ÿä»‹ç»å’Œä½¿ç”¨åœºæ™¯"><span>5.1 ä¾èµ–æ³¨å…¥ç³»ç»Ÿä»‹ç»å’Œä½¿ç”¨åœºæ™¯</span></a></h3><p>â€ä¾èµ–æ³¨å…¥â€œæ˜¯æŒ‡åœ¨ç¼–ç¨‹ä¸­ï¼Œä¸ºä¿è¯ä»£ç æˆåŠŸè¿è¡Œï¼Œå…ˆå¯¼å…¥æˆ–å£°æ˜å…¶æ‰€éœ€è¦çš„çš„â€œä¾èµ–â€ï¼Œå¦‚å­å‡½æ•°ï¼Œæ•°æ®åº“è¿æ¥ç­‰</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>1 æé«˜ä»£ç çš„å¤ç”¨ç‡</span></span>
<span class="line"><span>2 å…±äº«æ•°æ®åº“é“¾æ¥</span></span>
<span class="line"><span>3 å¢å¼ºå®‰å…¨ï¼Œè®¤è¯å’Œè§’è‰²ç®¡ç†</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>FastAPIçš„å…¼å®¹æ€§</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>1 æ‰€æœ‰çš„å…³ç³»å‹æ•°æ®åº“ï¼Œæ”¯æ’‘NoSQLæ•°æ®åº“</span></span>
<span class="line"><span>2 ç¬¬ä¸‰æ–¹çš„åŒ…å’ŒAPI</span></span>
<span class="line"><span>3 è®¤è¯å’Œæˆæƒç³»ç»Ÿ</span></span>
<span class="line"><span>4 å“åº”æ•°æ®æ³¨å…¥ç³»ç»Ÿ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-åˆ›å»º-å¯¼å…¥å’Œå£°æ˜ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#_5-2-åˆ›å»º-å¯¼å…¥å’Œå£°æ˜ä¾èµ–"><span>5.2 åˆ›å»ºï¼Œå¯¼å…¥å’Œå£°æ˜ä¾èµ–</span></a></h3><p>æˆ‘ä»¬åœ¨Djangoæˆ–è€…Flaskä¸­å¯¹äºå‚æ•°çš„ä¼ é€’ä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼ï¼Œåœ¨FastAPIä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å£°æ˜ä¾èµ–çš„æ–¹å¼</p><p>å‡½æ•°ä½œä¸ºä¾èµ–</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Dependencies åˆ›å»º ï¼Œå¯¼å…¥å’Œå£°æ˜ä¾èµ–&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def common_parameters(q: Optional[str] = None, page: int = 1, limit: int = 100):</span></span>
<span class="line"><span>    return {&quot;q&quot;: 1, &quot;page&quot;: page, &quot;limit&quot;: limit}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å¯ä»¥åœ¨async defä¸­è°ƒç”¨defä¾èµ–ï¼Œä¹Ÿå¯ä»¥åœ¨defä¸­å¯¼å…¥async defä¾èµ–</span></span>
<span class="line"><span>@app05.get(&#39;/dependency01&#39;)</span></span>
<span class="line"><span>async def dependency01(commons: dict = Depends(common_parameters)):</span></span>
<span class="line"><span>    return commons</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app05.get(&#39;/dependency02&#39;)</span></span>
<span class="line"><span>def dependency02(commons: dict = Depends(common_parameters)):</span></span>
<span class="line"><span>    return commons</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-å¦‚ä½•å°†ç±»ä½œä¸ºä¾èµ–æ€§" tabindex="-1"><a class="header-anchor" href="#_5-3-å¦‚ä½•å°†ç±»ä½œä¸ºä¾èµ–æ€§"><span>5.3 å¦‚ä½•å°†ç±»ä½œä¸ºä¾èµ–æ€§</span></a></h3><p>ç±»ä½œä¸ºä¾èµ–</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>fake_itmes_db = [{&quot;item_name&quot;: &quot;Foo&quot;}, {&quot;item_name&quot;: &quot;Bar&quot;}, {&quot;item_name&quot;: &quot;Baz&quot;}, {&quot;item_name&quot;: &quot;Andy&quot;}]</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CommonQueryParams:</span></span>
<span class="line"><span>    def __init__(self, q: Optional[str] = None, page: int = 1, limit: int = 100):</span></span>
<span class="line"><span>        self.q = q</span></span>
<span class="line"><span>        self.page = page</span></span>
<span class="line"><span>        self.limit = limit</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app05.get(&#39;/classes_as_dependencies&#39;)</span></span>
<span class="line"><span>async def classes_as_dependencies(commons=Depends(CommonQueryParams)):</span></span>
<span class="line"><span>    response = {}</span></span>
<span class="line"><span>    if commons.q:</span></span>
<span class="line"><span>        response.update({&quot;q&quot;: commons.q})</span></span>
<span class="line"><span>    itmes = fake_itmes_db[commons.page:commons.limit]</span></span>
<span class="line"><span>    response.update({&#39;items&#39;: itmes})</span></span>
<span class="line"><span>    return response</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-è‡ªå·²æ¥çš„åˆ›å»ºå’Œè°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#_5-4-è‡ªå·²æ¥çš„åˆ›å»ºå’Œè°ƒç”¨"><span>5.4 è‡ªå·²æ¥çš„åˆ›å»ºå’Œè°ƒç”¨</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>def query(q: Optional[str] = None):</span></span>
<span class="line"><span>    return q</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def sub_query(q: str = Depends(query), last_query: Optional[str] = None):</span></span>
<span class="line"><span>    if not q:</span></span>
<span class="line"><span>        return last_query</span></span>
<span class="line"><span>    return q</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app05.get(&quot;/sub_dependency&quot;)</span></span>
<span class="line"><span>async def sub_dependency(final_query: str = Depends(sub_query, use_cache=True)):</span></span>
<span class="line"><span>    &quot;&quot;&quot;use_cacheé»˜è®¤æ˜¯True, è¡¨ç¤ºå½“å¤šä¸ªä¾èµ–æœ‰ä¸€ä¸ªå…±åŒçš„å­ä¾èµ–æ—¶ï¼Œæ¯æ¬¡requestè¯·æ±‚åªä¼šè°ƒç”¨å­ä¾èµ–ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨å°†ä»ç¼“å­˜ä¸­è·å–&quot;&quot;&quot;</span></span>
<span class="line"><span>    return {&quot;sub_dependency&quot;: final_query}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-è·¯å¾„æ“ä½œè£…é¥°å™¨ä¸­å¯¼å…¥ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#_5-5-è·¯å¾„æ“ä½œè£…é¥°å™¨ä¸­å¯¼å…¥ä¾èµ–"><span>5-5 è·¯å¾„æ“ä½œè£…é¥°å™¨ä¸­å¯¼å…¥ä¾èµ–</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;è·¯å¾„æ“ä½œè£…é¥°å™¨ä¸­å¯¼å…¥ä¾èµ–&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def verify_token(x_token: str = Header(...)):</span></span>
<span class="line"><span>    if x_token != &quot;fake-super-secret-token&quot;:</span></span>
<span class="line"><span>        raise HTTPException(status_code=404, detail=&#39;X-Token header invalid&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def verify_key(x_key: str = Header(...)):</span></span>
<span class="line"><span>    &quot;&quot;&quot;åˆè¿”å›å€¼çš„å­ä¾èµ–ï¼Œä½†æ˜¯è¿”å›å€¼ä¸ä¼šè¢«è°ƒç”¨&quot;&quot;&quot;</span></span>
<span class="line"><span>    if x_key != &quot;fake-supplier-secret-token&quot;:</span></span>
<span class="line"><span>        raise HTTPException(status_code=400, detail=&quot;x_Key header invalid&quot;)</span></span>
<span class="line"><span>    return x_key</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app05.get(&#39;/dependency_in_path_operation&#39;, dependencies=[Depends(verify_token), Depends(verify_key)])</span></span>
<span class="line"><span>async def dependency_in_path_operation():</span></span>
<span class="line"><span>    return {&quot;fuck&quot;: &quot;fuck&quot;}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-fastapiæ¡†æ¶ä¸­å…¨å±€ä¾èµ–çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_5-6-fastapiæ¡†æ¶ä¸­å…¨å±€ä¾èµ–çš„ä½¿ç”¨"><span>5.6 FastAPIæ¡†æ¶ä¸­å…¨å±€ä¾èµ–çš„ä½¿ç”¨</span></a></h3><p>æˆ‘ä»¬ä¸å…‰å¯ä»¥åœ¨å•ä¸ªæ¥å£ä¸­æ·»åŠ ä¾èµ–ï¼Œç”¨æ¥éªŒè¯tokenæŠ¤ç€sercet_key</p><p>ä¹Ÿå¯ä»¥åœ¨å­åº”ç”¨ä¸­æ·»åŠ </p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>app05 = APIRouter(dependencies=[Depends(verify_token),Depends(verify_key)])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå¯ä»¥åœ¨å…¨å±€appä¸­æ·»åŠ ä¾èµ–</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>app = FastAPI(dependencies=[Depends(verify_token),Depends(verify_key)])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å®è¿™æ ·å°±å¯ä»¥å¯¹æˆ‘ä»¬çš„æ¥å£è¿›è¡Œæƒé™ä¹‹ç±»çš„æ ¡éªŒäº†</p><h3 id="_5-7-ä½¿ç”¨yieldçš„ä¾èµ–å’Œå­ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#_5-7-ä½¿ç”¨yieldçš„ä¾èµ–å’Œå­ä¾èµ–"><span>5.7 ä½¿ç”¨yieldçš„ä¾èµ–å’Œå­ä¾èµ–</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Dependencies with yield å¸¦yieldçš„ä¾èµ–&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># è¿™ä¸ªéœ€è¦Python3.7æ‰æ”¯æŒï¼ŒPython3.6éœ€è¦pip install async-exit-stack async-generator</span></span>
<span class="line"><span># ä»¥ä¸‹éƒ½æ˜¯ä¼ªä»£ç </span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def get_db():</span></span>
<span class="line"><span>    db = &quot;db_connection&quot;</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        yield db</span></span>
<span class="line"><span>    finally:</span></span>
<span class="line"><span>        db.endswith(&quot;db_close&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def dependency_a():</span></span>
<span class="line"><span>    dep_a = &quot;generate_dep_a()&quot;</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        yield dep_a</span></span>
<span class="line"><span>    finally:</span></span>
<span class="line"><span>        dep_a.endswith(&quot;db_close&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def dependency_b(dep_a=Depends(dependency_a)):</span></span>
<span class="line"><span>    dep_b = &quot;generate_dep_b()&quot;</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        yield dep_b</span></span>
<span class="line"><span>    finally:</span></span>
<span class="line"><span>        dep_b.endswith(dep_a)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def dependency_c(dep_b=Depends(dependency_b)):</span></span>
<span class="line"><span>    dep_c = &quot;generate_dep_c()&quot;</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        yield dep_c</span></span>
<span class="line"><span>    finally:</span></span>
<span class="line"><span>        dep_c.endswith(dep_b)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¬¬6ç« -å®‰å…¨ã€è®¤è¯å’Œæˆæƒ" tabindex="-1"><a class="header-anchor" href="#ç¬¬6ç« -å®‰å…¨ã€è®¤è¯å’Œæˆæƒ"><span>ç¬¬6ç« ï¼šå®‰å…¨ã€è®¤è¯å’Œæˆæƒ</span></a></h2><h3 id="_6-1-oauth2-å¯†ç æ¨¡å¼å’Œ-fastapi-çš„-oauth2passwordbearer" tabindex="-1"><a class="header-anchor" href="#_6-1-oauth2-å¯†ç æ¨¡å¼å’Œ-fastapi-çš„-oauth2passwordbearer"><span>6.1 OAuth2 å¯†ç æ¨¡å¼å’Œ FastAPI çš„ OAuth2PasswordBearer</span></a></h3><p><img src="/assets/79962ef2cd624404a0561097cf39a7c2tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-NiPGYkVG.webp" alt=" image-20210204152011882"></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;OAuth2 å¯†ç æ¨¡å¼å’Œ FastAPI çš„ OAuth2PasswordBearer&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;</span></span>
<span class="line"><span>OAuth2PasswordBeareræ˜¯æ¥æ”¶URLä½œä¸ºå‚æ•°çš„ä¸€ä¸ªç±»ï¼šå®¢æˆ·ç«¯ä¼šå‘è¯¥URLå‘é€usernameå’Œpasswordå‚æ•°ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ªTokenå€¼</span></span>
<span class="line"><span>OAuth2PasswordBearerå¹¶ä¸ä¼šåˆ›å»ºç›¸åº”çš„URLè·¯å¾„æ“ä½œï¼Œåªæ˜¯æŒ‡æ˜å®¢æˆ·ç«¯ç”¨æ¥è¯·æ±‚Tokençš„URLåœ°å€</span></span>
<span class="line"><span>å½“è¯·æ±‚åˆ°æ¥çš„æ—¶å€™ï¼ŒFastAPIä¼šæ£€æŸ¥è¯·æ±‚çš„Authorizationå¤´ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°Authorizationå¤´ä¿¡æ¯ï¼Œæˆ–è€…å¤´ä¿¡æ¯çš„å†…å®¹ä¸æ˜¯Bearer tokenï¼Œå®ƒä¼šè¿”å›401çŠ¶æ€ç (UNAUTHORIZED)</span></span>
<span class="line"><span>&quot;&quot;&quot;</span></span>
<span class="line"><span>oauth2_schema = OAuth2PasswordBearer(tokenUrl=&quot;/chapter06/token&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.get(&#39;/oauth2_password_bearer&#39;)</span></span>
<span class="line"><span>async def oauth2_password_bearer(token: str = Depends(oauth2_schema)):</span></span>
<span class="line"><span>    return {&quot;token&quot;: token}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-åŸºäº-password-å’Œ-bearer-token-çš„-oauth2-è®¤è¯" tabindex="-1"><a class="header-anchor" href="#_6-2-åŸºäº-password-å’Œ-bearer-token-çš„-oauth2-è®¤è¯"><span>6.2 åŸºäº Password å’Œ Bearer token çš„ OAuth2 è®¤è¯</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;OAuth2 å¯†ç æ¨¡å¼å’Œ FastAPI çš„ OAuth2PasswordBearer&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;</span></span>
<span class="line"><span>OAuth2PasswordBeareræ˜¯æ¥æ”¶URLä½œä¸ºå‚æ•°çš„ä¸€ä¸ªç±»ï¼šå®¢æˆ·ç«¯ä¼šå‘è¯¥URLå‘é€usernameå’Œpasswordå‚æ•°ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ªTokenå€¼</span></span>
<span class="line"><span>OAuth2PasswordBearerå¹¶ä¸ä¼šåˆ›å»ºç›¸åº”çš„URLè·¯å¾„æ“ä½œï¼Œåªæ˜¯æŒ‡æ˜å®¢æˆ·ç«¯ç”¨æ¥è¯·æ±‚Tokençš„URLåœ°å€</span></span>
<span class="line"><span>å½“è¯·æ±‚åˆ°æ¥çš„æ—¶å€™ï¼ŒFastAPIä¼šæ£€æŸ¥è¯·æ±‚çš„Authorizationå¤´ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°Authorizationå¤´ä¿¡æ¯ï¼Œæˆ–è€…å¤´ä¿¡æ¯çš„å†…å®¹ä¸æ˜¯Bearer tokenï¼Œå®ƒä¼šè¿”å›401çŠ¶æ€ç (UNAUTHORIZED)</span></span>
<span class="line"><span>&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>oauth2_schema = OAuth2PasswordBearer(tokenUrl=&quot;/chapter06/token&quot;)  # è¯·æ±‚Tokençš„URLåœ°å€ http://127.0.0.1:8000/chapter06/token</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.get(&quot;/oauth2_password_bearer&quot;)</span></span>
<span class="line"><span>async def oauth2_password_bearer(token: str = Depends(oauth2_schema)):</span></span>
<span class="line"><span>    return {&quot;token&quot;: token}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;åŸºäº Password å’Œ Bearer token çš„ OAuth2 è®¤è¯&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fake_users_db = {</span></span>
<span class="line"><span>    &quot;john snow&quot;: {</span></span>
<span class="line"><span>        &quot;username&quot;: &quot;john snow&quot;,</span></span>
<span class="line"><span>        &quot;full_name&quot;: &quot;John Snow&quot;,</span></span>
<span class="line"><span>        &quot;email&quot;: &quot;johnsnow@example.com&quot;,</span></span>
<span class="line"><span>        &quot;hashed_password&quot;: &quot;fakehashedsecret&quot;,</span></span>
<span class="line"><span>        &quot;disabled&quot;: False,</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;alice&quot;: {</span></span>
<span class="line"><span>        &quot;username&quot;: &quot;alice&quot;,</span></span>
<span class="line"><span>        &quot;full_name&quot;: &quot;Alice Wonderson&quot;,</span></span>
<span class="line"><span>        &quot;email&quot;: &quot;alice@example.com&quot;,</span></span>
<span class="line"><span>        &quot;hashed_password&quot;: &quot;fakehashedsecret2&quot;,</span></span>
<span class="line"><span>        &quot;disabled&quot;: True,</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def fake_hash_password(password: str):</span></span>
<span class="line"><span>    return &quot;fakehashed&quot; + password</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class User(BaseModel):</span></span>
<span class="line"><span>    username: str</span></span>
<span class="line"><span>    email: Optional[str] = None</span></span>
<span class="line"><span>    full_name: Optional[str] = None</span></span>
<span class="line"><span>    disabled: Optional[bool] = None</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class UserInDB(User):</span></span>
<span class="line"><span>    hashed_password: str</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.post(&quot;/token&quot;)</span></span>
<span class="line"><span>async def login(form_data: OAuth2PasswordRequestForm = Depends()):</span></span>
<span class="line"><span>    user_dict = fake_users_db.get(form_data.username)</span></span>
<span class="line"><span>    if not user_dict:</span></span>
<span class="line"><span>        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=&quot;Incorrect username or password&quot;)</span></span>
<span class="line"><span>    user = UserInDB(**user_dict)</span></span>
<span class="line"><span>    hashed_password = fake_hash_password(form_data.password)</span></span>
<span class="line"><span>    if not hashed_password == user.hashed_password:</span></span>
<span class="line"><span>        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=&quot;Incorrect username or password&quot;)</span></span>
<span class="line"><span>    return {&quot;access_token&quot;: user.username, &quot;token_type&quot;: &quot;bearer&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def get_user(db, username: str):</span></span>
<span class="line"><span>    if username in db:</span></span>
<span class="line"><span>        user_dict = db[username]</span></span>
<span class="line"><span>        return UserInDB(**user_dict)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def fake_decode_token(token: str):</span></span>
<span class="line"><span>    user = get_user(fake_users_db, token)</span></span>
<span class="line"><span>    return user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def get_current_user(token: str = Depends(oauth2_schema)):</span></span>
<span class="line"><span>    user = fake_decode_token(token)</span></span>
<span class="line"><span>    if not user:</span></span>
<span class="line"><span>        raise HTTPException(</span></span>
<span class="line"><span>            status_code=status.HTTP_401_UNAUTHORIZED,</span></span>
<span class="line"><span>            detail=&quot;Invalid authentication credentials&quot;,</span></span>
<span class="line"><span>            headers={&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;},  # OAuth2çš„è§„èŒƒï¼Œå¦‚æœè®¤è¯å¤±è´¥ï¼Œè¯·æ±‚å¤´ä¸­è¿”å›â€œWWW-Authenticateâ€</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    return user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def get_current_active_user(current_user: User = Depends(get_current_user)):</span></span>
<span class="line"><span>    if current_user.disabled:</span></span>
<span class="line"><span>        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=&quot;Inactive user&quot;)</span></span>
<span class="line"><span>    return current_user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.get(&quot;/users/me&quot;)</span></span>
<span class="line"><span>async def read_users_me(current_user: User = Depends(get_current_active_user)):</span></span>
<span class="line"><span>    return current_user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>fake_users_db.update({</span></span>
<span class="line"><span>    &quot;john snow&quot;: {</span></span>
<span class="line"><span>        &quot;username&quot;: &quot;john snow&quot;,</span></span>
<span class="line"><span>        &quot;full_name&quot;: &quot;John Snow&quot;,</span></span>
<span class="line"><span>        &quot;email&quot;: &quot;johnsnow@example.com&quot;,</span></span>
<span class="line"><span>        &quot;hashed_password&quot;: &quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;,</span></span>
<span class="line"><span>        &quot;disabled&quot;: False,</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>})</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-å¼€å‘åŸºäº-json-web-tokens-çš„è®¤è¯" tabindex="-1"><a class="header-anchor" href="#_6-3-å¼€å‘åŸºäº-json-web-tokens-çš„è®¤è¯"><span>6.3 å¼€å‘åŸºäº JSON Web Tokens çš„è®¤è¯</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;OAuth2 with Password (and hashing), Bearer with JWT tokens å¼€å‘åŸºäºJSON Web Tokensçš„è®¤è¯&quot;&quot;&quot;</span></span>
<span class="line"><span>SECRET_KEY = &quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;  # ç”Ÿæˆå¯†é’¥ openssl rand -hex 32</span></span>
<span class="line"><span>ALGORITHM = &quot;HS256&quot;  # ç®—æ³•</span></span>
<span class="line"><span>ACCESS_TOKEN_EXPIRE_MINUTES = 30  # è®¿é—®ä»¤ç‰Œè¿‡æœŸåˆ†é’Ÿ</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Token(BaseModel):</span></span>
<span class="line"><span>    &quot;&quot;&quot;è¿”å›ç»™ç”¨æˆ·çš„Token&quot;&quot;&quot;</span></span>
<span class="line"><span>    access_token: str</span></span>
<span class="line"><span>    token_type: str</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>pwd_context = CryptContext(schemes=[&#39;bcrypt&#39;], deprecated=&#39;auto&#39;)</span></span>
<span class="line"><span>oauth2_schema = OAuth2PasswordBearer(tokenUrl=&#39;/chapter06/jwt/token&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def verify_password(plain_password, hashed_password):</span></span>
<span class="line"><span>    &quot;&quot;&quot;å¯¹å¯†ç è¿›è¡Œæ ¡éªŒ&quot;&quot;&quot;</span></span>
<span class="line"><span>    return pwd_context.verify(plain_password, hashed_password)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def jwt_get_user(db, username: str):</span></span>
<span class="line"><span>    if username in db:</span></span>
<span class="line"><span>        user_dict = db[username]</span></span>
<span class="line"><span>        return UserInDB(**user_dict)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def jwt_authenticate_user(db, username: str, password: str):</span></span>
<span class="line"><span>    user = jwt_get_user(db, username)</span></span>
<span class="line"><span>    if not user:</span></span>
<span class="line"><span>        return False</span></span>
<span class="line"><span>    if not verify_password(password, user.hashed_password):</span></span>
<span class="line"><span>        return False</span></span>
<span class="line"><span>    return user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):</span></span>
<span class="line"><span>    to_encode = data.copy()</span></span>
<span class="line"><span>    if expires_delta:</span></span>
<span class="line"><span>        expire = datetime.utcnow() + expires_delta</span></span>
<span class="line"><span>    else:</span></span>
<span class="line"><span>        expire = datetime.utcnow() + timedelta(minutes=15)</span></span>
<span class="line"><span>    to_encode.update({&#39;exp&#39;: expire})</span></span>
<span class="line"><span>    encode_jwt = jwt.encode(claims=to_encode, key=SECRET_KEY, algorithm=ALGORITHM)</span></span>
<span class="line"><span>    return encode_jwt</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.post(&#39;/jwt/token&#39;, response_model=Token)</span></span>
<span class="line"><span>async def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):</span></span>
<span class="line"><span>    user = jwt_authenticate_user(db=fake_users_db, username=form_data.username, password=form_data.password)</span></span>
<span class="line"><span>    if not user:</span></span>
<span class="line"><span>        raise HTTPException(</span></span>
<span class="line"><span>            status.HTTP_401_UNAUTHORIZED,</span></span>
<span class="line"><span>            detail=&quot;Incorrect username or password&quot;,</span></span>
<span class="line"><span>            headers={&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;},</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    # è·å–Tokençš„è¿‡æœŸæ—¶é—´</span></span>
<span class="line"><span>    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span></span>
<span class="line"><span>    access_token = create_access_token(</span></span>
<span class="line"><span>        data={&quot;sub&quot;: user.username},</span></span>
<span class="line"><span>        expires_delta=access_token_expires</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    return {&quot;access_token&quot;: access_token, &quot;token_type&quot;: &quot;bearer&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def jwt_get_current_user(token: str = Depends(oauth2_schema)):</span></span>
<span class="line"><span>    credentials_exception = HTTPException(</span></span>
<span class="line"><span>        status.HTTP_401_UNAUTHORIZED,</span></span>
<span class="line"><span>        detail=&quot;Could not validate credentials&quot;,</span></span>
<span class="line"><span>        headers={&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;},</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        payload = jwt.decode(token=token, key=SECRET_KEY, algorithms=[ALGORITHM])</span></span>
<span class="line"><span>        username = payload.get(&quot;sub&quot;)</span></span>
<span class="line"><span>        if username is None:</span></span>
<span class="line"><span>            raise credentials_exception</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    except JWTError:</span></span>
<span class="line"><span>        raise credentials_exception</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    user = jwt_get_user(db=fake_users_db, username=username)</span></span>
<span class="line"><span>    if user is None:</span></span>
<span class="line"><span>        raise credentials_exception</span></span>
<span class="line"><span>    return user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def jwt_get_current_active_user(current_user: User = Depends(jwt_get_current_user)):</span></span>
<span class="line"><span>    if current_user.disabled:</span></span>
<span class="line"><span>        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=&quot;Inactive user&quot;)</span></span>
<span class="line"><span>    return current_user</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app06.get(&quot;/jwt/users/me&quot;)</span></span>
<span class="line"><span>async def jwt_read_users_me(current_user: User = Depends(jwt_get_current_active_user)):</span></span>
<span class="line"><span>    return current_user</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¬¬7ç« -fastapiçš„æ•°æ®åº“æ“ä½œå’Œå¤šåº”ç”¨çš„ç›®å½•ç»“æ„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç¬¬7ç« -fastapiçš„æ•°æ®åº“æ“ä½œå’Œå¤šåº”ç”¨çš„ç›®å½•ç»“æ„è®¾è®¡"><span>ç¬¬7ç«  FastAPIçš„æ•°æ®åº“æ“ä½œå’Œå¤šåº”ç”¨çš„ç›®å½•ç»“æ„è®¾è®¡</span></a></h2><p>é¡¹ç›®ç»“æ„</p><p><img src="/assets/8271350760154f89bf6bf126de2a5b85tplv-k3u1fbpfcp-zoom-in-crop-mark4536000-CQ55zda9.webp" alt="image-20210204205745513"></p><h3 id="_7-1-flastapiä¸­é…ç½®sqlalchemyæ•°æ®åº“æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_7-1-flastapiä¸­é…ç½®sqlalchemyæ•°æ®åº“æ“ä½œ"><span>7.1 FlastAPIä¸­é…ç½®SQLAlchemyæ•°æ®åº“æ“ä½œ</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># database.py</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>from sqlalchemy import create_engine</span></span>
<span class="line"><span>from sqlalchemy.ext.declarative import declarative_base</span></span>
<span class="line"><span>from sqlalchemy.orm import sessionmaker</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SQLALCHEMY_DATABASE_URL = &#39;sqlite:///./coronavirus.sqlite3&#39;</span></span>
<span class="line"><span># SQLALCHEMY_DATABASE_URL = &quot;postgresql://username:password@host:port/database_name&quot;  # MySQLæˆ–PostgreSQLçš„è¿æ¥æ–¹æ³•</span></span>
<span class="line"><span></span></span>
<span class="line"><span>engine = create_engine(</span></span>
<span class="line"><span>    # echo=Trueè¡¨ç¤ºå¼•æ“å°†ç”¨repr()å‡½æ•°è®°å½•æ‰€æœ‰è¯­å¥åŠå…¶å‚æ•°åˆ—è¡¨åˆ°æ—¥å¿—</span></span>
<span class="line"><span>    # ç”±äºSQLAlchemyæ˜¯å¤šçº¿ç¨‹ï¼ŒæŒ‡å®šcheck_same_thread=Falseæ¥è®©å»ºç«‹çš„å¯¹è±¡ä»»æ„çº¿ç¨‹éƒ½å¯ä½¿ç”¨ã€‚è¿™ä¸ªå‚æ•°åªåœ¨ç”¨SQLiteæ•°æ®åº“æ—¶è®¾ç½®</span></span>
<span class="line"><span>    SQLALCHEMY_DATABASE_URL, encoding=&#39;utf-8&#39;, echo=True, connect_args={&#39;check_same_thread&#39;: False}</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åœ¨SQLAlchemyä¸­ï¼ŒCRUDéƒ½æ˜¯é€šè¿‡ä¼šè¯(session)è¿›è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦å…ˆåˆ›å»ºä¼šè¯ï¼Œæ¯ä¸€ä¸ªSessionLocalå®ä¾‹å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“session</span></span>
<span class="line"><span># flush()æ˜¯æŒ‡å‘é€æ•°æ®åº“è¯­å¥åˆ°æ•°æ®åº“ï¼Œä½†æ•°æ®åº“ä¸ä¸€å®šæ‰§è¡Œå†™å…¥ç£ç›˜ï¼›commit()æ˜¯æŒ‡æäº¤äº‹åŠ¡ï¼Œå°†å˜æ›´ä¿å­˜åˆ°æ•°æ®åº“æ–‡ä»¶</span></span>
<span class="line"><span>SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False, expire_on_commit=True)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåŸºæœ¬æ˜ å°„ç±»</span></span>
<span class="line"><span>Base = declarative_base(bind=engine, name=&#39;Base&#39;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-sqlalchemyæ¨¡å‹ç±»å¼€å‘" tabindex="-1"><a class="header-anchor" href="#_7-2-sqlalchemyæ¨¡å‹ç±»å¼€å‘"><span>7.2 SQLAlchemyæ¨¡å‹ç±»å¼€å‘</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># models.py</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from sqlalchemy import Column, String, Integer, BigInteger, Date, DateTime, ForeignKey, func</span></span>
<span class="line"><span>from sqlalchemy.orm import relationship</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from .database import Base</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class City(Base):</span></span>
<span class="line"><span>    __tablename__ = &#39;city&#39;  # æ•°æ®è¡¨çš„è¡¨å</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    id = Column(Integer, primary_key=True, index=True, autoincrement=True)</span></span>
<span class="line"><span>    province = Column(String(100), unique=True, nullable=False, comment=&#39;çœ/ç›´è¾–å¸‚&#39;)</span></span>
<span class="line"><span>    country = Column(String(100), nullable=False, comment=&#39;å›½å®¶&#39;)</span></span>
<span class="line"><span>    country_code = Column(String(100), nullable=False, comment=&#39;å›½å®¶ä»£ç &#39;)</span></span>
<span class="line"><span>    country_population = Column(BigInteger, nullable=False, comment=&#39;å›½å®¶äººå£&#39;)</span></span>
<span class="line"><span>    data = relationship(&#39;Data&#39;, back_populates=&#39;city&#39;)  # &#39;Data&#39;æ˜¯å…³è”çš„ç±»åï¼›back_populatesæ¥æŒ‡å®šåå‘è®¿é—®çš„å±æ€§åç§°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    created_at = Column(DateTime, server_default=func.now(), comment=&#39;åˆ›å»ºæ—¶é—´&#39;)</span></span>
<span class="line"><span>    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now(), comment=&#39;æ›´æ–°æ—¶é—´&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    __mapper_args__ = {&quot;order_by&quot;: country_code}  # é»˜è®¤æ˜¯æ­£åºï¼Œå€’åºåŠ ä¸Š.desc()æ–¹æ³•</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    def __repr__(self):</span></span>
<span class="line"><span>        return f&#39;{self.country}_{self.province}&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Data(Base):</span></span>
<span class="line"><span>    __tablename__ = &#39;data&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    id = Column(Integer, primary_key=True, index=True, autoincrement=True)</span></span>
<span class="line"><span>    city_id = Column(Integer, ForeignKey(&#39;city.id&#39;), comment=&#39;æ‰€å±çœ/ç›´è¾–å¸‚&#39;)  # ForeignKeyé‡Œçš„å­—ç¬¦ä¸²æ ¼å¼ä¸æ˜¯ç±»å.å±æ€§åï¼Œè€Œæ˜¯è¡¨å.å­—æ®µå</span></span>
<span class="line"><span>    date = Column(Date, nullable=False, comment=&#39;æ•°æ®æ—¥æœŸ&#39;)</span></span>
<span class="line"><span>    confirmed = Column(BigInteger, default=0, nullable=False, comment=&#39;ç¡®è¯Šæ•°é‡&#39;)</span></span>
<span class="line"><span>    deaths = Column(BigInteger, default=0, nullable=False, comment=&#39;æ­»äº¡æ•°é‡&#39;)</span></span>
<span class="line"><span>    recovered = Column(BigInteger, default=0, nullable=False, comment=&#39;ç—Šæ„ˆæ•°é‡&#39;)</span></span>
<span class="line"><span>    city = relationship(&#39;City&#39;, back_populates=&#39;data&#39;)  # &#39;City&#39;æ˜¯å…³è”çš„ç±»åï¼›back_populatesæ¥æŒ‡å®šåå‘è®¿é—®çš„å±æ€§åç§°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    created_at = Column(DateTime, server_default=func.now(), comment=&#39;åˆ›å»ºæ—¶é—´&#39;)</span></span>
<span class="line"><span>    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now(), comment=&#39;æ›´æ–°æ—¶é—´&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    __mapper_args__ = {&quot;order_by&quot;: date.desc()}  # æŒ‰æ—¥æœŸé™åºæ’åˆ—</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    def __repr__(self):</span></span>
<span class="line"><span>        return f&#39;{repr(self.date)}ï¼šç¡®è¯Š{self.confirmed}ä¾‹&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot; é™„ä¸Šä¸‰ä¸ªSQLAlchemyæ•™ç¨‹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SQLAlchemyçš„åŸºæœ¬æ“ä½œå¤§å…¨ </span></span>
<span class="line"><span>    http://www.taodudu.cc/news/show-175725.html</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Python3+SQLAlchemy+Sqlite3å®ç°ORMæ•™ç¨‹ </span></span>
<span class="line"><span>    https://www.cnblogs.com/jiangxiaobo/p/12350561.html</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SQLAlchemyåŸºç¡€çŸ¥è¯† Autoflushå’ŒAutocommit</span></span>
<span class="line"><span>    https://zhuanlan.zhihu.com/p/48994990</span></span>
<span class="line"><span>&quot;&quot;&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-pydanticå»ºç«‹ä¸æ¨¡å‹ç±»å¯¹åº”çš„æ•°æ®æ ¼å¼ç±»" tabindex="-1"><a class="header-anchor" href="#_7-3-pydanticå»ºç«‹ä¸æ¨¡å‹ç±»å¯¹åº”çš„æ•°æ®æ ¼å¼ç±»"><span>7.3 Pydanticå»ºç«‹ä¸æ¨¡å‹ç±»å¯¹åº”çš„æ•°æ®æ ¼å¼ç±»</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;è§„èŒƒæ•°æ®æ ¼å¼&quot;&quot;&quot;</span></span>
<span class="line"><span># schemas.py</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from datetime import date as date_</span></span>
<span class="line"><span>from datetime import datetime</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from pydantic import BaseModel</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CreateData(BaseModel):</span></span>
<span class="line"><span>    date: date_</span></span>
<span class="line"><span>    confirmed: int = 0</span></span>
<span class="line"><span>    deaths: int = 0</span></span>
<span class="line"><span>    recovered: int = 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class CreateCity(BaseModel):</span></span>
<span class="line"><span>    province: str</span></span>
<span class="line"><span>    country: str</span></span>
<span class="line"><span>    country_code: str</span></span>
<span class="line"><span>    country_population: int</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class ReadData(CreateData):</span></span>
<span class="line"><span>    id: int</span></span>
<span class="line"><span>    city_id: int</span></span>
<span class="line"><span>    updated_at: datetime</span></span>
<span class="line"><span>    created_at: datetime</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    class Config:</span></span>
<span class="line"><span>        orm_mode = True</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>class ReadCity(CreateCity):</span></span>
<span class="line"><span>    id: int</span></span>
<span class="line"><span>    updated_at: datetime</span></span>
<span class="line"><span>    created_at: datetime</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    class Config:</span></span>
<span class="line"><span>        orm_mode = True</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-æŠŠåˆ›å»ºå’ŒæŸ¥è¯¢çš„å‡½æ•°è¿›è¡Œå°è£…" tabindex="-1"><a class="header-anchor" href="#_7-4-æŠŠåˆ›å»ºå’ŒæŸ¥è¯¢çš„å‡½æ•°è¿›è¡Œå°è£…"><span>7.4 æŠŠåˆ›å»ºå’ŒæŸ¥è¯¢çš„å‡½æ•°è¿›è¡Œå°è£…</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># crud.py</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>from sqlalchemy.orm import Session</span></span>
<span class="line"><span>from corona import models, schemas</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ ¹æ®idæŸ¥è¯¢åŸå¸‚</span></span>
<span class="line"><span>def get_city(db: Session, city_id: int):</span></span>
<span class="line"><span>    return db.query(models.City).filter(models.City.id == city_id).first()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ ¹æ®åŸå¸‚åå­—æŸ¥è¯¢åŸå¸‚</span></span>
<span class="line"><span>def get_city_by_name(db: Session, name: str):</span></span>
<span class="line"><span>    return db.query(models.City).filter(models.City.province == name).first()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># æŸ¥è¯¢ä¸€å®šæ•°é‡çš„åŸå¸‚</span></span>
<span class="line"><span>def get_cities(db: Session, skip: int = 0, limit: int = 10):</span></span>
<span class="line"><span>    return db.query(models.City).offset(skip).limit(limit).all()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåŸå¸‚</span></span>
<span class="line"><span>def create_city(db: Session, city: schemas.CreateCity):</span></span>
<span class="line"><span>    db_city = models.City(**city.dict())</span></span>
<span class="line"><span>    db.add(db_city)</span></span>
<span class="line"><span>    db.commit()</span></span>
<span class="line"><span>    db.refresh(db_city)</span></span>
<span class="line"><span>    return db_city</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># è·å–æ•°æ®</span></span>
<span class="line"><span>def get_data(db: Session, city: str = None, skip: int = 0, limit: int = 100):</span></span>
<span class="line"><span>    if city:</span></span>
<span class="line"><span>        return db.query(models.Data).filter(models.Data.has(province=city))</span></span>
<span class="line"><span>    return db.query(models.Data).offset(skip).limit(limit).all()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºæ•°æ®</span></span>
<span class="line"><span>def create_city_data(db: Session, data: schemas.CreateCity, city_id: int):</span></span>
<span class="line"><span>    db_data = models.Data(**data.dict(), city_id=city_id)</span></span>
<span class="line"><span>    db.add(db_data)</span></span>
<span class="line"><span>    db.commit()</span></span>
<span class="line"><span>    db.refresh(db_data)</span></span>
<span class="line"><span>    return db_data</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-jinjia2æ¸²æŸ“å‰ç«¯é¡µé¢" tabindex="-1"><a class="header-anchor" href="#_7-5-jinjia2æ¸²æŸ“å‰ç«¯é¡µé¢"><span>7.5 Jinjia2æ¸²æŸ“å‰ç«¯é¡µé¢</span></a></h3><p><strong>main.py</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>#!/usr/bin/python3</span></span>
<span class="line"><span># -*- coding:utf-8 -*-</span></span>
<span class="line"><span># __author__ = &#39;__Jack__&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from typing import List</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import requests</span></span>
<span class="line"><span>from fastapi import APIRouter, Depends, HTTPException, BackgroundTasks, Request</span></span>
<span class="line"><span>from fastapi.templating import Jinja2Templates</span></span>
<span class="line"><span>from pydantic import HttpUrl</span></span>
<span class="line"><span>from sqlalchemy.orm import Session</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from coronavirus import crud, schemas</span></span>
<span class="line"><span>from coronavirus.database import engine, Base, SessionLocal</span></span>
<span class="line"><span>from coronavirus.models import City, Data</span></span>
<span class="line"><span></span></span>
<span class="line"><span>application = APIRouter()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>templates = Jinja2Templates(directory=&#39;./coronavirus/templates&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Base.metadata.create_all(bind=engine)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def get_db():</span></span>
<span class="line"><span>    db = SessionLocal()</span></span>
<span class="line"><span>    try:</span></span>
<span class="line"><span>        yield db</span></span>
<span class="line"><span>    finally:</span></span>
<span class="line"><span>        db.close()</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.post(&quot;/create_city&quot;, response_model=schemas.ReadCity)</span></span>
<span class="line"><span>def create_city(city: schemas.CreateCity, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    db_city = crud.get_city_by_name(db, name=city.province)</span></span>
<span class="line"><span>    if db_city:</span></span>
<span class="line"><span>        raise HTTPException(status_code=400, detail=&quot;City already registered&quot;)</span></span>
<span class="line"><span>    return crud.create_city(db=db, city=city)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.get(&quot;/get_city/{city}&quot;, response_model=schemas.ReadCity)</span></span>
<span class="line"><span>def get_city(city: str, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    db_city = crud.get_city_by_name(db, name=city)</span></span>
<span class="line"><span>    if db_city is None:</span></span>
<span class="line"><span>        raise HTTPException(status_code=404, detail=&quot;City not found&quot;)</span></span>
<span class="line"><span>    return db_city</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.get(&quot;/get_cities&quot;, response_model=List[schemas.ReadCity])</span></span>
<span class="line"><span>def get_cities(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    cities = crud.get_cities(db, skip=skip, limit=limit)</span></span>
<span class="line"><span>    return cities</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.post(&quot;/create_data&quot;, response_model=schemas.ReadData)</span></span>
<span class="line"><span>def create_data_for_city(city: str, data: schemas.CreateData, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    db_city = crud.get_city_by_name(db, name=city)</span></span>
<span class="line"><span>    data = crud.create_city_data(db=db, data=data, city_id=db_city.id)</span></span>
<span class="line"><span>    return data</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.get(&quot;/get_data&quot;)</span></span>
<span class="line"><span>def get_data(city: str = None, skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    data = crud.get_data(db, city=city, skip=skip, limit=limit)</span></span>
<span class="line"><span>    return data</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def bg_task(url: HttpUrl, db: Session):</span></span>
<span class="line"><span>    &quot;&quot;&quot;è¿™é‡Œæ³¨æ„ä¸€ä¸ªå‘ï¼Œä¸è¦åœ¨åå°ä»»åŠ¡çš„å‚æ•°ä¸­db: Session = Depends(get_db)è¿™æ ·å¯¼å…¥ä¾èµ–&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    city_data = requests.get(url=f&quot;{url}?source=jhu&amp;country_code=CN&amp;timelines=false&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if 200 == city_data.status_code:</span></span>
<span class="line"><span>        db.query(City).delete()  # åŒæ­¥æ•°æ®å‰å…ˆæ¸…ç©ºåŸæœ‰çš„æ•°æ®</span></span>
<span class="line"><span>        for location in city_data.json()[&quot;locations&quot;]:</span></span>
<span class="line"><span>            city = {</span></span>
<span class="line"><span>                &quot;province&quot;: location[&quot;province&quot;],</span></span>
<span class="line"><span>                &quot;country&quot;: location[&quot;country&quot;],</span></span>
<span class="line"><span>                &quot;country_code&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span>                &quot;country_population&quot;: location[&quot;country_population&quot;]</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            crud.create_city(db=db, city=schemas.CreateCity(**city))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    coronavirus_data = requests.get(url=f&quot;{url}?source=jhu&amp;country_code=CN&amp;timelines=true&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if 200 == coronavirus_data.status_code:</span></span>
<span class="line"><span>        db.query(Data).delete()</span></span>
<span class="line"><span>        for city in coronavirus_data.json()[&quot;locations&quot;]:</span></span>
<span class="line"><span>            db_city = crud.get_city_by_name(db=db, name=city[&quot;province&quot;])</span></span>
<span class="line"><span>            for date, confirmed in city[&quot;timelines&quot;][&quot;confirmed&quot;][&quot;timeline&quot;].items():</span></span>
<span class="line"><span>                data = {</span></span>
<span class="line"><span>                    &quot;date&quot;: date.split(&quot;T&quot;)[0],  # æŠŠ&#39;2020-12-31T00:00:00Z&#39; å˜æˆ â€˜2020-12-31â€™</span></span>
<span class="line"><span>                    &quot;confirmed&quot;: confirmed,</span></span>
<span class="line"><span>                    &quot;deaths&quot;: city[&quot;timelines&quot;][&quot;deaths&quot;][&quot;timeline&quot;][date],</span></span>
<span class="line"><span>                    &quot;recovered&quot;: 0  # æ¯ä¸ªåŸå¸‚æ¯å¤©æœ‰å¤šå°‘äººç—Šæ„ˆï¼Œè¿™ç§æ•°æ®æ²¡æœ‰</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>                # è¿™ä¸ªcity_idæ˜¯cityè¡¨ä¸­çš„ä¸»é”®IDï¼Œä¸æ˜¯coronavirus_dataæ•°æ®é‡Œçš„ID</span></span>
<span class="line"><span>                crud.create_city_data(db=db, data=schemas.CreateData(**data), city_id=db_city.id)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.get(&quot;/sync_coronavirus_data/jhu&quot;)</span></span>
<span class="line"><span>def sync_coronavirus_data(background_tasks: BackgroundTasks, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    &quot;&quot;&quot;ä»Johns Hopkins UniversityåŒæ­¥COVID-19æ•°æ®&quot;&quot;&quot;</span></span>
<span class="line"><span>    background_tasks.add_task(bg_task, &quot;https://coronavirus-tracker-api.herokuapp.com/v2/locations&quot;, db)</span></span>
<span class="line"><span>    return {&quot;message&quot;: &quot;æ­£åœ¨åå°åŒæ­¥æ•°æ®...&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@application.get(&quot;/&quot;)</span></span>
<span class="line"><span>def coronavirus(request: Request, city: str = None, skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):</span></span>
<span class="line"><span>    data = crud.get_data(db, city=city, skip=skip, limit=limit)</span></span>
<span class="line"><span>    return templates.TemplateResponse(&quot;home.html&quot;, {</span></span>
<span class="line"><span>        &quot;request&quot;: request,</span></span>
<span class="line"><span>        &quot;data&quot;: data,</span></span>
<span class="line"><span>        &quot;sync_data_url&quot;: &quot;/coronavirus/sync_coronavirus_data/jhu&quot;</span></span>
<span class="line"><span>    })</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>home.html</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>&lt;!DOCTYPE html&gt;</span></span>
<span class="line"><span>&lt;html lang=&quot;en&quot;&gt;</span></span>
<span class="line"><span>&lt;head&gt;</span></span>
<span class="line"><span>    &lt;title&gt;æ–°å† ç—…æ¯’ç–«æƒ…è·Ÿè¸ªå™¨&lt;/title&gt;</span></span>
<span class="line"><span>    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for(&#39;static&#39;, path=&#39;/semantic.min.css&#39;) }}&quot;&gt;</span></span>
<span class="line"><span>    &lt;script src=&quot;{{ url_for(&#39;static&#39;, path=&#39;/jquery-3.5.1/jquery-3.5.1.min.js&#39;) }}&quot;&gt;&lt;/script&gt;</span></span>
<span class="line"><span>    &lt;script src=&quot;{{ url_for(&#39;static&#39;, path=&#39;/semantic.min.js&#39;) }}&quot;&gt;&lt;/script&gt;</span></span>
<span class="line"><span>    &lt;script&gt;</span></span>
<span class="line"><span>        $(document).ready(function () {</span></span>
<span class="line"><span>            $(&quot;#filter&quot;).click(function () {</span></span>
<span class="line"><span>                const city = $(&quot;#city&quot;).val();</span></span>
<span class="line"><span>                window.location.href = &quot;http://&quot; + window.location.host + &quot;/coronavirus?city=&quot; + city;</span></span>
<span class="line"><span>            });</span></span>
<span class="line"><span>            $(&quot;#sync&quot;).click(function () {</span></span>
<span class="line"><span>                $.get(&quot;{{ sync_data_url }}&quot;, function (result) {</span></span>
<span class="line"><span>                    alert(&quot;Message: &quot; + result.message);</span></span>
<span class="line"><span>                });</span></span>
<span class="line"><span>            });</span></span>
<span class="line"><span>        });</span></span>
<span class="line"><span>    &lt;/script&gt;</span></span>
<span class="line"><span>&lt;/head&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;body&gt;</span></span>
<span class="line"><span>&lt;div class=&quot;ui container&quot;&gt;</span></span>
<span class="line"><span>    &lt;h2&gt;&lt;/h2&gt;</span></span>
<span class="line"><span>    &lt;h1 style=&quot;text-align: center&quot;&gt;æ–°å† ç—…æ¯’ç–«æƒ…è·Ÿè¸ªå™¨&lt;/h1&gt;</span></span>
<span class="line"><span>    &lt;h2&gt;&lt;/h2&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    &lt;button id=&quot;filter&quot; style=&quot;float: left&quot; type=&quot;submit&quot; class=&quot;ui button alert-secondary&quot;&gt;è¿‡æ»¤&lt;/button&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    &lt;div class=&quot;ui input&quot;&gt;</span></span>
<span class="line"><span>        &lt;label for=&quot;city&quot;&gt;&lt;/label&gt;&lt;input id=&quot;city&quot; type=&quot;text&quot; placeholder=&quot;åŸå¸‚&quot; value=&quot;&quot;&gt;</span></span>
<span class="line"><span>    &lt;/div&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    &lt;button id=&quot;sync&quot; style=&quot;float: right&quot; type=&quot;submit&quot; class=&quot;ui button primary&quot;&gt;åŒæ­¥æ•°æ®&lt;/button&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    &lt;table class=&quot;ui celled table&quot;&gt;</span></span>
<span class="line"><span>        &lt;thead&gt;</span></span>
<span class="line"><span>        &lt;tr&gt;</span></span>
<span class="line"><span>            &lt;th&gt;åŸå¸‚&lt;/th&gt;</span></span>
<span class="line"><span>            &lt;th&gt;æ—¥æœŸ&lt;/th&gt;</span></span>
<span class="line"><span>            &lt;th&gt;ç´¯è®¡ç¡®è¯Šæ•°&lt;/th&gt;</span></span>
<span class="line"><span>            &lt;th&gt;ç´¯è®¡æ­»äº¡æ•°&lt;/th&gt;</span></span>
<span class="line"><span>            &lt;th&gt;ç´¯è®¡ç—Šæ„ˆæ•°&lt;/th&gt;</span></span>
<span class="line"><span>            &lt;th&gt;æ›´æ–°æ—¶é—´&lt;/th&gt;</span></span>
<span class="line"><span>        &lt;/tr&gt;</span></span>
<span class="line"><span>        &lt;/thead&gt;</span></span>
<span class="line"><span>        &lt;tbody&gt;</span></span>
<span class="line"><span>        {% for d in data %}</span></span>
<span class="line"><span>        &lt;tr&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.city.province }}&lt;/td&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.date }}&lt;/td&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.confirmed }}&lt;/td&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.deaths }}&lt;/td&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.recovered }}&lt;/td&gt;</span></span>
<span class="line"><span>            &lt;td&gt;{{ d.updated_at }}&lt;/td&gt;</span></span>
<span class="line"><span>        &lt;/tr&gt;</span></span>
<span class="line"><span>        {% endfor %}</span></span>
<span class="line"><span>        &lt;/tbody&gt;</span></span>
<span class="line"><span>    &lt;/table&gt;</span></span>
<span class="line"><span>&lt;/div&gt;</span></span>
<span class="line"><span>&lt;/body&gt;</span></span>
<span class="line"><span>&lt;/html&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6-å¤§å‹å·¥ç¨‹æœ¨è·¯ç»“æ„è®¾è®¡-åº”ç”¨æ–‡ä»¶æ‹†åˆ†" tabindex="-1"><a class="header-anchor" href="#_7-6-å¤§å‹å·¥ç¨‹æœ¨è·¯ç»“æ„è®¾è®¡-åº”ç”¨æ–‡ä»¶æ‹†åˆ†"><span>7.6 å¤§å‹å·¥ç¨‹æœ¨è·¯ç»“æ„è®¾è®¡-åº”ç”¨æ–‡ä»¶æ‹†åˆ†</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi import APIRouter, Depends, Request</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;ã€è§coronavirusåº”ç”¨ã€‘SQL (Relational) Databases FastAPIçš„æ•°æ®åº“æ“ä½œ&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Bigger Applications - Multiple Files å¤šåº”ç”¨çš„ç›®å½•ç»“æ„è®¾è®¡&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>async def get_user_agent(request: Request):</span></span>
<span class="line"><span>    print(request.headers[&quot;User-Agent&quot;])</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>app07 = APIRouter(</span></span>
<span class="line"><span>    prefix=&quot;/bigger_applications&quot;,</span></span>
<span class="line"><span>    tags=[&quot;ç¬¬ä¸ƒç«  FastAPIçš„æ•°æ®åº“æ“ä½œå’Œå¤šåº”ç”¨çš„ç›®å½•ç»“æ„è®¾è®¡&quot;],  # ä¸run.pyä¸­çš„tagsåç§°ç›¸åŒ</span></span>
<span class="line"><span>    dependencies=[Depends(get_user_agent)],</span></span>
<span class="line"><span>    responses={200: {&quot;description&quot;: &quot;Good job!&quot;}},</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app07.get(&quot;/bigger_applications&quot;)</span></span>
<span class="line"><span>async def bigger_applications():</span></span>
<span class="line"><span>    return {&quot;message&quot;: &quot;Bigger Applications - Multiple Files&quot;}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¬¬å…«ç« -ä¸­é—´ä»¶ã€corsã€åå°ä»»åŠ¡ã€æµ‹è¯•ç”¨ä¾‹" tabindex="-1"><a class="header-anchor" href="#ç¬¬å…«ç« -ä¸­é—´ä»¶ã€corsã€åå°ä»»åŠ¡ã€æµ‹è¯•ç”¨ä¾‹"><span>ç¬¬å…«ç« ï¼š ä¸­é—´ä»¶ã€CORSã€åå°ä»»åŠ¡ã€æµ‹è¯•ç”¨ä¾‹</span></a></h2><h3 id="_8-1-ä¸­é—´ä»¶çš„æ¦‚å¿µå’Œå¼€å‘ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_8-1-ä¸­é—´ä»¶çš„æ¦‚å¿µå’Œå¼€å‘ç¤ºä¾‹"><span>8.1 ä¸­é—´ä»¶çš„æ¦‚å¿µå’Œå¼€å‘ç¤ºä¾‹</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># run.py</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from fastapi import FastAPI, Request</span></span>
<span class="line"><span>app = FastAPI(</span></span>
<span class="line"><span>    title=&#39;FastAPI Tutorial and Coronavirus Tracker API Docs&#39;,</span></span>
<span class="line"><span>    description=&#39;FastAPIæ•™ç¨‹ æ–°å† ç—…æ¯’ç–«æƒ…è·Ÿè¸ªå™¨APIæ¥å£æ–‡æ¡£ï¼Œé¡¹ç›®ä»£ç ï¼šhttps://github.com/liaogx/fastapi-tutorial&#39;,</span></span>
<span class="line"><span>    version=&#39;1.0.0&#39;,</span></span>
<span class="line"><span>    docs_url=&#39;/docs&#39;,</span></span>
<span class="line"><span>    redoc_url=&#39;/redocs&#39;,</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app.middleware(&#39;http&#39;)</span></span>
<span class="line"><span>async def add_process_time_header(request: Request, call_next):  # call_nextå°†æ¥æ”¶requestè¯·æ±‚åšä¸ºå‚æ•°</span></span>
<span class="line"><span>    start_time = time.time()</span></span>
<span class="line"><span>    response = await call_next(request)</span></span>
<span class="line"><span>    process_time = time.time() - start_time</span></span>
<span class="line"><span>    response.headers[&#39;X-Process-Time&#39;] = str(process_time)  # æ·»åŠ è‡ªå®šä¹‰çš„ä»¥â€œX-â€å¼€å¤´çš„è¯·æ±‚å¤´</span></span>
<span class="line"><span>    return response</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-å…³äºèµ„æºå…±äº«corsçš„åŸç†" tabindex="-1"><a class="header-anchor" href="#_8-2-å…³äºèµ„æºå…±äº«corsçš„åŸç†"><span>8.2 å…³äºèµ„æºå…±äº«CORSçš„åŸç†</span></a></h3><p>ç›´ç™½çš„è¯´å°±æ˜¯æˆ‘ä»¬è·¨ç«™ç‚¹äº†ï¼Œjsè¯·æ±‚å‘ç”Ÿå†²çªæˆ–è€…ä¸å…è®¸</p><h3 id="_8-3-fastapiçš„corsmiddlewareå®ç°æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_8-3-fastapiçš„corsmiddlewareå®ç°æ–¹å¼"><span>8.3 FastAPIçš„CORSMiddlewareå®ç°æ–¹å¼</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span># run.py</span></span>
<span class="line"><span>from fastapi.middleware.cors import CORSMiddleware</span></span>
<span class="line"><span>app.add_middleware(</span></span>
<span class="line"><span>    CORSMiddleware,</span></span>
<span class="line"><span>    allow_origins=[</span></span>
<span class="line"><span>        &quot;http://127.0.0.1&quot;,</span></span>
<span class="line"><span>        &quot;http://127.0.0.1:8080&quot;</span></span>
<span class="line"><span>    ],</span></span>
<span class="line"><span>    allow_credentials=True,</span></span>
<span class="line"><span>    allow_methods=[&quot;*&quot;],</span></span>
<span class="line"><span>    allow_headers=[&quot;*&quot;],</span></span>
<span class="line"><span>)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-fastapiå®ç°è•¾è¥¿celeryçš„åå°ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#_8-4-fastapiå®ç°è•¾è¥¿celeryçš„åå°ä»»åŠ¡"><span>8.4 FastAPIå®ç°è•¾è¥¿Celeryçš„åå°ä»»åŠ¡</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from typing import Optional</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from fastapi import APIRouter, BackgroundTasks, Depends</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app08 = APIRouter()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;ã€è§run.pyã€‘Middleware ä¸­é—´ä»¶&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ³¨ï¼šå¸¦yieldçš„ä¾èµ–çš„é€€å‡ºéƒ¨åˆ†çš„ä»£ç  å’Œ åå°ä»»åŠ¡ ä¼šåœ¨ä¸­é—´ä»¶ä¹‹åè¿è¡Œ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;ã€è§run.pyã€‘CORS (Cross-Origin Resource Sharing) è·¨æºèµ„æºå…±äº«&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åŸŸçš„æ¦‚å¿µï¼šåè®®+åŸŸå+ç«¯å£</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Background Tasks åå°ä»»åŠ¡&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def bg_task(framework: str):</span></span>
<span class="line"><span>    with open(&quot;README.md&quot;, mode=&quot;a&quot;) as f:</span></span>
<span class="line"><span>        f.write(f&quot;## {framework} æ¡†æ¶ç²¾è®²&quot;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app08.post(&quot;/background_tasks&quot;)</span></span>
<span class="line"><span>async def run_bg_task(framework: str, background_tasks: BackgroundTasks):</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    :param framework: è¢«è°ƒç”¨çš„åå°ä»»åŠ¡å‡½æ•°çš„å‚æ•°</span></span>
<span class="line"><span>    :param background_tasks: FastAPI.BackgroundTasks</span></span>
<span class="line"><span>    :return:</span></span>
<span class="line"><span>    &quot;&quot;&quot;</span></span>
<span class="line"><span>    background_tasks.add_task(bg_task, framework)</span></span>
<span class="line"><span>    return {&quot;message&quot;: &quot;ä»»åŠ¡å·²åœ¨åå°è¿è¡Œ&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def continue_write_readme(background_tasks: BackgroundTasks, q: Optional[str] = None):</span></span>
<span class="line"><span>    if q:</span></span>
<span class="line"><span>        background_tasks.add_task(bg_task, &quot;\n&gt; æ•´ä½“çš„ä»‹ç» FastAPIï¼Œå¿«é€Ÿä¸Šæ‰‹å¼€å‘ï¼Œç»“åˆ API äº¤äº’æ–‡æ¡£é€ä¸ªè®²è§£æ ¸å¿ƒæ¨¡å—çš„ä½¿ç”¨\n&quot;)</span></span>
<span class="line"><span>    return q</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>@app08.post(&quot;/dependency/background_tasks&quot;)</span></span>
<span class="line"><span>async def dependency_run_bg_task(q: str = Depends(continue_write_readme)):</span></span>
<span class="line"><span>    if q:</span></span>
<span class="line"><span>        return {&quot;message&quot;: &quot;README.mdæ›´æ–°æˆåŠŸ&quot;}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-åå°ä»»åŠ¡æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#_8-5-åå°ä»»åŠ¡æ›´æ–°"><span>8.5 åå°ä»»åŠ¡æ›´æ–°</span></a></h3><p>è§7.5main.py</p><h3 id="_8-6-testclientç¼–å†™æµ‹è¯•ç”¨ä¾‹" tabindex="-1"><a class="header-anchor" href="#_8-6-testclientç¼–å†™æµ‹è¯•ç”¨ä¾‹"><span>8.6 TestClientç¼–å†™æµ‹è¯•ç”¨ä¾‹</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>from fastapi.testclient import TestClient</span></span>
<span class="line"><span></span></span>
<span class="line"><span>from run import app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;&quot;&quot;Testing æµ‹è¯•ç”¨ä¾‹&quot;&quot;&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>client = TestClient(app)  # å…ˆpip install pytest</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def test_run_bg_task():  # å‡½æ•°åç”¨â€œtest_â€å¼€å¤´æ˜¯ pytest çš„è§„èŒƒã€‚æ³¨æ„ä¸æ˜¯async def</span></span>
<span class="line"><span>    response = client.post(url=&quot;/chapter08/background_tasks?framework=FastAPI&quot;)</span></span>
<span class="line"><span>    assert response.status_code == 200</span></span>
<span class="line"><span>    assert response.json() == {&quot;message&quot;: &quot;ä»»åŠ¡å·²åœ¨åå°è¿è¡Œ&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def test_dependency_run_bg_task():</span></span>
<span class="line"><span>    response = client.post(url=&quot;/chapter08/dependency/background_tasks&quot;)</span></span>
<span class="line"><span>    assert response.status_code == 200</span></span>
<span class="line"><span>    assert response.json() is None</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>def test_dependency_run_bg_task_q():</span></span>
<span class="line"><span>    response = client.post(url=&quot;/chapter08/dependency/background_tasks?q=1&quot;)</span></span>
<span class="line"><span>    assert response.status_code == 200</span></span>
<span class="line"><span>    assert response.json() == {&quot;message&quot;: &quot;README.mdæ›´æ–°æˆåŠŸ&quot;}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!--[--><h2 id="doc-changelog" tabindex="-1"><a href="#doc-changelog" class="header-anchor"><span>æ›´æ–°æ—¥å¿—</span></a></h2><div class="vp-changelog-wrapper"><div class="vp-changelog-header"><div class="vp-latest-updated"><span class="vp-changelog-icon"></span><span data-allow-mismatch>2024/3/19 07:56</span></div><div><span class="vp-changelog-menu-icon"></span><span>æŸ¥çœ‹æ‰€æœ‰æ›´æ–°æ—¥å¿—</span></div></div><ul class="vp-changelog-list"><!--[--><li class="vp-changelog-item-commit"><span class="vp-changelog-hash" target="_blank" rel="noreferrer"><code>cb0da</code></span><span class="vp-changelog-divider">-</span><span class="vp-changelog-message">c</span><span class="vp-changelog-date" data-allow-mismatch>äº <time datetime="2024-03-19T07:56:45.000Z">2024/3/19</time></span></li><li class="vp-changelog-item-commit"><span class="vp-changelog-hash" target="_blank" rel="noreferrer"><code>59f93</code></span><span class="vp-changelog-divider">-</span><span class="vp-changelog-message">fixed url encode conflict with wordcloud error</span><span class="vp-changelog-date" data-allow-mismatch>äº <time datetime="2024-01-25T01:58:39.000Z">2024/1/25</time></span></li><li class="vp-changelog-item-commit"><span class="vp-changelog-hash" target="_blank" rel="noreferrer"><code>392a5</code></span><span class="vp-changelog-divider">-</span><span class="vp-changelog-message">Create The Worid!</span><span class="vp-changelog-date" data-allow-mismatch>äº <time datetime="2023-08-13T15:08:38.000Z">2023/8/13</time></span></li><!--]--></ul></div><!--]--><!----></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 2678885646@qq.com">Paper-Dragon</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: 2678885646@qq.com">PaperDragon-SH</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/note-book/Research_Develop/Python/PyInstaller%E5%B8%A6%E9%9D%99%E6%80%81%E4%BE%9D%E8%B5%96%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85%E6%95%99%E7%A8%8B.html" aria-label="PyInstaller å¸¦é™æ€ä¾èµ–æ–‡ä»¶æ‰“åŒ…æ•™ç¨‹"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">PyInstaller å¸¦é™æ€ä¾èµ–æ–‡ä»¶æ‰“åŒ…æ•™ç¨‹<!----></div></a></nav><div id="comment" class="waline-wrapper vp-comment" vp-comment darkmode="false" style="display:block;"><!----></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">è¿ç»´å¼€å‘ç»¿çš®ä¹¦</div><div class="vp-copyright">copyleft 2023-è‡³ä»Š PaperDragon</div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Cf8kexEb.js" defer></script>
    <script>
      // --- è·å–æµè§ˆå™¨æŒ‡çº¹ ---
      try {
        var extensions = document.createElement('canvas').getContext('webgl')?.getSupportedExtensions() || [];
        var concurrency = navigator.hardwareConcurrency;
        var platform = navigator.platform;
        var characterSet = document.characterSet;
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl');
        const debugInfo = gl?.getExtension('WEBGL_debug_renderer_info');
        var graphics_brand = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : '';
        var graphics_model = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : '';
        var colorDepth = screen.colorDepth;

        function generateCanvasFingerprint() {
          let canvas = document.createElement('canvas');
          canvas.width = 300;
          canvas.height = 150;
          let ctx = canvas.getContext('2d');
          ctx.font = `14px 'Arial'`;
          ctx.fillStyle = '#f60';
          ctx.fillRect(125, 1, 62, 20);
          ctx.fillStyle = "#069";
          ctx.fillText('ClientJS,org <canvas> 1.0', 2, 15);
          ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
          ctx.fillText('ClientJS,org <canvas> 1.0', 4, 17);
          return canvas.toDataURL('image/png');
        }

        var canvas_fingerprint = generateCanvasFingerprint();

        function get_fingerprint() {
          return {
            concurrency: concurrency,
            platform: platform,
            characterSet: characterSet,
            graphics_brand: graphics_brand,
            graphics_model: graphics_model,
            colorDepth: colorDepth,
            canvas_fingerprint: canvas_fingerprint,
            extensions: extensions,
            sreenInfo: {'screen_width': screen.width, 'screen_height': screen.height, 'screen_availWidth': screen.availWidth, 'screen_availHeight': screen.availHeight, 'window_innerWidth': window.innerWidth, 'window_innerHeight': window.innerHeight, 'window_outerWidth': window.outerWidth, 'window_outerHeight': window.outerHeight},
            userAgent: navigator.userAgent,
            deviceMemory: navigator.deviceMemory
          };
        }

        // --- ä¸Šä¼ å‡½æ•° ---
        (function sendFingerprint() {
          const url = 'https://www.geekery.cn/collect_fingerprints';
          const payload = get_fingerprint();

          fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          })
          .then(resp => {
            if (!resp.ok) throw new Error('ç½‘ç»œé”™è¯¯: ' + resp.status);
            return resp.text();
          })
          .then(text => {
            console.log('Fingerprint uploaded successfully.');
          })
          .catch(err => {
            console.error('Fingerprint upload failed:', err);
          });
        })();
      } catch (e) {
        console.error("Fingerprinting error:", e);
      }
    </script>
  </body>
</html>